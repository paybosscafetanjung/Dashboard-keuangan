<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard - Business Day Logic</title>
  <!-- Chart.js & Tailwind -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; width: 100%;
    }
    * { box-sizing: border-box; }

    .dashboard-container { width: 100%; min-height: 100%; padding: 24px; max-width: 1200px; margin: 0 auto; }

    .header {
      background: white; padding: 24px; border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
    }
    .header h1 { margin: 0; color: #1a202c; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
    .header p { margin: 0; color: #718096; font-size: 14px; font-weight: 500; }

    .filter-section {
      background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
      padding: 10px; border-radius: 12px; margin-bottom: 24px;
      display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .filter-btn {
      padding: 10px 20px; border: none; background: transparent; border-radius: 8px;
      cursor: pointer; font-size: 14px; font-weight: 600; color: #4a5568; transition: all 0.2s ease;
    }
    .filter-btn:hover { background: #edf2f7; color: #2d3748; }
    .filter-btn.active { background: white; color: #667eea; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    .download-btn {
      padding: 10px 20px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700;
      margin-left: auto; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
    }
    .download-btn:hover { transform: translateY(-2px); }

    .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px; }
    
    .card {
      background: white; padding: 24px; border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-2px); }
    .card h3 {
      margin: 0 0 20px 0; color: #2d3748; font-size: 18px; font-weight: 700;
      display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #f7fafc; padding-bottom: 10px;
    }

    .chart-container { position: relative; height: 250px; width: 100%; }

    .top-item {
      display: flex; justify-content: space-between; align-items: center; padding: 12px;
      background: #f8fafc; border-radius: 10px; border-left: 4px solid #667eea; margin-bottom: 8px;
    }
    .top-item-name { font-weight: 600; color: #2d3748; font-size: 14px; }
    .top-item-count { font-weight: 800; color: #667eea; font-size: 15px; background: #ebf4ff; padding: 4px 8px; border-radius: 6px; }

    .basket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .basket-item {
      padding: 12px; background: linear-gradient(135deg, #fdfbf7 0%, #fff 100%);
      border: 1px solid #e2e8f0; border-radius: 10px; text-align: center; font-size: 12px; color: #4a5568; font-weight: 600;
    }

    .shift-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .shift-card { padding: 20px; border-radius: 16px; color: white; position: relative; overflow: hidden; }
    .shift-card::after { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1)); }
    
    .shift-pagi { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
    .shift-siang { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #1a202c !important; }
    .shift-siang h4, .shift-siang .shift-total { color: #2d3748; }
    .shift-malam { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }

    .shift-card h4 { margin: 0 0 15px 0; font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
    .shift-info { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 500; opacity: 0.9; }
    .shift-total { font-size: 28px; font-weight: 800; margin-top: 15px; }

    .stock-items { display: flex; flex-wrap: wrap; gap: 10px; }
    .stock-item {
      padding: 10px 16px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 30px;
      display: flex; align-items: center; gap: 8px;
    }
    .stock-item-name { font-weight: 600; color: #c53030; font-size: 13px; }
    .stock-item-qty { background: #c53030; color: white; font-weight: 700; font-size: 12px; padding: 2px 8px; border-radius: 10px; }

    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table thead { background: #f7fafc; }
    .data-table th { padding: 14px; text-align: left; font-weight: 600; color: #4a5568; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0; }
    .data-table td { padding: 14px; border-bottom: 1px solid #edf2f7; color: #2d3748; font-size: 14px; }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover { background-color: #f8fafc; }

    .action-btn-sm { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-right: 4px; }
    .btn-edit { background: #ebf8ff; color: #3182ce; border: 1px solid #bee3f8; }
    .btn-delete { background: #fff5f5; color: #e53e3e; border: 1px solid #fed7d7; }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(26, 32, 44, 0.7); backdrop-filter: blur(4px);
      z-index: 100; display: none; justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
    .modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.2s; }
    .modal-overlay.active .modal-card { transform: scale(1); }
    .modal-card h3 { margin: 0 0 20px 0; color: #2d3748; font-size: 22px; font-weight: 800; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; color: #4a5568; font-weight: 600; font-size: 13px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: border 0.2s; }

    #auth-overlay {
      position: fixed; inset: 0; background: #f7fafc; z-index: 2000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .login-box {
      background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      width: 90%; max-width: 350px; text-align: center;
    }
    .empty-state { text-align: center; color: #a0aec0; padding: 30px; font-style: italic; font-size: 14px; }
    
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .download-btn { width: 100%; margin-top: 10px; text-align: center; }
      .filter-section { justify-content: center; }
    }
  </style>
 </head>
 <body>

  <div id="auth-overlay">
      <div class="login-box">
          <h2 style="font-size:24px; font-weight:800; color:#2d3748; margin-bottom:8px;">Manager Access</h2>
          <p style="color:#718096; margin-bottom:24px; font-size:14px;">Login untuk akses data real-time.</p>
          
          <div id="login-form-container">
              <input type="email" id="mgr-email" placeholder="Email Manager" class="form-group input" style="margin-bottom:10px;">
              <input type="password" id="mgr-pass" placeholder="Password" class="form-group input" style="margin-bottom:20px;">
              <button onclick="managerLogin()" style="width:100%; padding:12px; background:#667eea; color:white; border-radius:10px; font-weight:700; border:none; cursor:pointer;">Masuk Dashboard</button>
          </div>
          <p id="auth-status" style="margin-top:15px; color:#667eea; font-size:13px; font-weight:600; display:none;">Menghubungkan ke Database...</p>
      </div>
  </div>

  <div class="dashboard-container">
   <div class="header">
    <div>
        <h1>üìä Manager Dashboard</h1>
        <p>Data Real-time dari POS & Staff App</p>
    </div>
    <button class="download-btn" onclick="downloadReport()">üì• Download Laporan</button>
   </div>

   <div class="filter-section">
    <button class="filter-btn active" data-filter="today">Hari Ini (Operational)</button>
    <button class="filter-btn" data-filter="week">Minggu Ini</button>
    <button class="filter-btn" data-filter="month">Bulan Ini</button>
   </div>

   <div class="analytics-grid">
    <!-- Peak Hour -->
    <div class="card">
     <h3>üìà Analisis Jam Sibuk (Data POS)</h3>
     <div class="chart-container"><canvas id="peakHourChart"></canvas></div>
    </div>
    
    <!-- Top Menu -->
    <div class="card">
     <h3>üçΩÔ∏è Menu Terlaris (Data POS)</h3>
     <div id="topItemsList"><div class="empty-state">Menunggu data POS...</div></div>
    </div>
    
    <!-- Market Basket -->
    <div class="card">
     <h3>üõí Kombinasi Menu Favorit</h3>
     <div id="basketAnalysis" class="basket-grid"><div class="empty-state">Belum ada pola...</div></div>
    </div>
   </div>

   <div class="card" style="background: transparent; box-shadow: none; padding: 0;">
    <h3 style="margin-bottom: 16px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üí∞ Monitoring Shift (Hari Ini)</h3>
    <div class="shift-cards" id="shiftCards">
     <div class="shift-card shift-pagi">
      <h4>üåÖ Shift Pagi (08:00-15:59)</h4>
      <div class="shift-info"><span>QRIS</span> <span id="pagi-qris">Rp 0</span></div>
      <div class="shift-info"><span>Cash</span> <span id="pagi-cash">Rp 0</span></div>
      <div class="shift-total" id="pagi-total">Rp 0</div>
     </div>
     <div class="shift-card shift-siang">
      <h4>üåÜ Shift Siang (16:00-22:59)</h4>
      <div class="shift-info"><span>QRIS</span> <span id="siang-qris">Rp 0</span></div>
      <div class="shift-info"><span>Cash</span> <span id="siang-cash">Rp 0</span></div>
      <div class="shift-total" id="siang-total">Rp 0</div>
     </div>
     <div class="shift-card shift-malam">
      <h4>üåô Shift Malam (23:00-07:59)</h4>
      <div class="shift-info"><span>QRIS</span> <span id="malam-qris">Rp 0</span></div>
      <div class="shift-info"><span>Cash</span> <span id="malam-cash">Rp 0</span></div>
      <div class="shift-total" id="malam-total">Rp 0</div>
     </div>
    </div>
   </div>

   <div class="analytics-grid" style="margin-top: 24px;">
       <div class="card">
        <h3>‚ö†Ô∏è Stok Menipis (< 5 Unit)</h3>
        <div id="stockAlerts" class="stock-items"><div class="empty-state">Semua stok aman</div></div>
       </div>
       
       <div class="card">
        <h3>üö´ Log Pembatalan (Void)</h3>
        <div id="voidList" style="max-height: 200px; overflow-y: auto;">
            <div class="empty-state">Tidak ada pembatalan</div>
        </div>
       </div>
   </div>

   <div class="card">
    <h3>üë• Laporan Tutup Shift (Dari Staff App)</h3>
    <div class="table-container">
     <table class="data-table">
      <thead>
       <tr>
        <th>Tanggal</th><th>Shift</th><th>Staff</th><th>Modal</th><th>Fisik Laci</th><th>Selisih</th><th>Aksi</th>
       </tr>
      </thead>
      <tbody id="staffDataTable">
       <tr><td colspan="7" class="empty-state">Belum ada data shift</td></tr>
      </tbody>
     </table>
    </div>
   </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal-overlay">
   <div class="modal-card">
    <h3>‚úèÔ∏è Edit Data Shift</h3>
    <form id="editForm">
     <div class="form-group"><label>Shift</label> <select id="edit-shift"> <option value="Pagi">Pagi</option> <option value="Siang">Siang</option> <option value="Malam">Malam</option> </select></div>
     <div class="form-group"><label>Staff</label> <input type="text" id="edit-staff" required></div>
     <div class="form-group"><label>Modal Awal</label> <input type="number" id="edit-modal" min="0"></div>
     <div class="form-group"><label>Fisik Laci</label> <input type="number" id="edit-fisik" min="0"></div>
     <div style="display:flex; gap:10px; margin-top:20px;">
         <button type="button" onclick="closeEditModal()" style="flex:1; padding:12px; border:none; background:#e2e8f0; color:#4a5568; border-radius:8px; font-weight:600; cursor:pointer;">Batal</button> 
         <button type="submit" style="flex:1; padding:12px; border:none; background:#667eea; color:white; border-radius:8px; font-weight:600; cursor:pointer;">Simpan</button>
     </div>
    </form>
   </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, onSnapshot, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
      authDomain: "payboss-cafe-system.firebaseapp.com",
      projectId: "payboss-cafe-system",
      storageBucket: "payboss-cafe-system.firebasestorage.app",
      messagingSenderId: "570523503793",
      appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
      measurementId: "G-H1NJ369HE9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allCompletedOrders = [];
    let allShiftReports = [];
    let allInventory = [];
    let allVoided = [];
    let currentFilter = 'today';
    let currentEditRecordId = null;
    let peakHourChart = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('auth-status').style.display = 'block';
            setupRealtimeListeners();
        }
    });

    window.managerLogin = async () => {
        const e = document.getElementById('mgr-email').value;
        const p = document.getElementById('mgr-pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { alert("Login gagal: " + err.message); }
    };

    function setupRealtimeListeners() {
        // 1. completedOrders
        onSnapshot(collection(db, "completedOrders"), (snapshot) => {
            allCompletedOrders = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().createdAt?.seconds * 1000}));
            updateDashboard();
        });

        // 2. shift_reports
        onSnapshot(collection(db, "shift_reports"), (snapshot) => {
            allShiftReports = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().createdAt?.seconds * 1000}));
            updateDashboard();
        });

        // 3. Inventory
        const qKitchen = query(collection(db, "inventory_kitchen"));
        const qBar = query(collection(db, "inventory_bar"));
        onSnapshot(qKitchen, (snapK) => {
            const kItems = snapK.docs.map(d => ({...d.data(), type: 'Dapur'}));
            getDocs(qBar).then(snapB => {
                const bItems = snapB.docs.map(d => ({...d.data(), type: 'Bar'}));
                allInventory = [...kItems, ...bItems];
                updateDashboard();
            });
        });

        // 4. Void
        onSnapshot(collection(db, "voidedOrders"), (snapshot) => {
            allVoided = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().voidedAt?.seconds * 1000}));
            updateDashboard();
        });

        document.getElementById('auth-overlay').style.display = 'none';
    }

    function updateDashboard() {
        const filteredOrders = filterDataByPeriod(allCompletedOrders, currentFilter);
        const filteredShifts = filterDataByPeriod(allShiftReports, currentFilter);
        const filteredVoids = filterDataByPeriod(allVoided, currentFilter);

        updatePeakHourChart(filteredOrders);
        updateTopItems(filteredOrders);
        updateBasketAnalysis(filteredOrders);
        updateShiftMonitoringFromOrders(filteredOrders);
        updateStockAlerts(allInventory);
        updateStaffDataTable(filteredShifts);
        updateVoidList(filteredVoids);
    }

    // --- LOGIKA "BUSINESS DAY" (Start 08:00) ---
    function getBusinessDate(timestamp) {
        const d = new Date(timestamp);
        // Jika jam 00:00 - 07:59, itu masih milik HARI KEMARIN (Business Date)
        if (d.getHours() < 8) {
            d.setDate(d.getDate() - 1);
        }
        d.setHours(0, 0, 0, 0);
        return d.getTime();
    }

    function filterDataByPeriod(data, period) {
        const now = new Date();
        const currentBusinessDate = getBusinessDate(now.getTime()); // Dapatkan "Tanggal Bisnis" hari ini

        return data.filter(record => {
            if (!record.timestamp) return false;
            const recordBusinessDate = getBusinessDate(record.timestamp);

            if (period === 'today') {
                // Filter: Apakah tanggal bisnis record ini == tanggal bisnis sekarang?
                return recordBusinessDate === currentBusinessDate;
            } 
            else if (period === 'week') {
                const weekAgo = currentBusinessDate - (7 * 24 * 60 * 60 * 1000);
                return recordBusinessDate >= weekAgo;
            } 
            else if (period === 'month') {
                const monthAgo = currentBusinessDate - (30 * 24 * 60 * 60 * 1000);
                return recordBusinessDate >= monthAgo;
            }
            return true;
        });
    }

    function updatePeakHourChart(data) {
        const hourData = new Array(24).fill(0);
        data.forEach(t => { if(t.timestamp) hourData[new Date(t.timestamp).getHours()] += (t.total || 0); });

        const ctx = document.getElementById('peakHourChart');
        if (peakHourChart) peakHourChart.destroy();

        peakHourChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                datasets: [{ label: 'Penjualan (Rp)', data: hourData, backgroundColor: '#667eea', borderRadius: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: {beginAtZero: true} } }
        });
    }

    function updateTopItems(data) {
        const counts = {};
        data.forEach(t => (t.items || []).forEach(i => counts[i.name] = (counts[i.name] || 0) + (i.qty || 1)));
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        const container = document.getElementById('topItemsList');
        container.innerHTML = sorted.length ? sorted.map(([n, c]) => `<div class="top-item"><span class="top-item-name">${n}</span><span class="top-item-count">${c}x</span></div>`).join('') : '<div class="empty-state">Menunggu data transaksi...</div>';
    }

    function updateBasketAnalysis(data) {
        const pairs = {};
        data.forEach(t => {
            const items = (t.items || []).map(i => i.name).sort();
            for(let i=0; i<items.length; i++) for(let j=i+1; j<items.length; j++) pairs[`${items[i]} + ${items[j]}`] = (pairs[`${items[i]} + ${items[j]}`] || 0) + 1;
        });
        const sorted = Object.entries(pairs).sort((a,b) => b[1] - a[1]).slice(0, 4);
        const container = document.getElementById('basketAnalysis');
        container.innerHTML = sorted.length ? sorted.map(([c, n]) => `<div class="basket-item">${c} (${n})</div>`).join('') : '<div class="empty-state">Belum ada pola</div>';
    }

    function updateShiftMonitoringFromOrders(data) {
        const totals = { Pagi: {q:0, c:0}, Siang: {q:0, c:0}, Malam: {q:0, c:0} };
        
        data.forEach(o => {
            const h = new Date(o.timestamp).getHours();
            let s = 'Malam'; // Default malam (untuk 23:00 - 07:59)
            if (h >= 8 && h < 16) s = 'Pagi';
            else if (h >= 16 && h < 23) s = 'Siang';

            const method = (o.paymentMethod || 'cash').toLowerCase();
            if(method.includes('qris') || method.includes('transfer')) totals[s].q += (o.total||0);
            else totals[s].c += (o.total||0);
        });

        ['pagi','siang','malam'].forEach(k => {
            const Key = k.charAt(0).toUpperCase() + k.slice(1);
            document.getElementById(`${k}-qris`).textContent = formatRupiah(totals[Key].q);
            document.getElementById(`${k}-cash`).textContent = formatRupiah(totals[Key].c);
            document.getElementById(`${k}-total`).textContent = formatRupiah(totals[Key].q + totals[Key].c);
        });
    }

    function updateStockAlerts(data) {
        const low = data.filter(i => (i.stock||0) < 5);
        const container = document.getElementById('stockAlerts');
        container.innerHTML = low.length ? low.map(i => `<div class="stock-item"><span class="stock-item-name">${i.name}</span><span class="stock-item-qty">${i.stock}</span></div>`).join('') : '<div class="empty-state">Aman</div>';
    }

    function updateStaffDataTable(data) {
        const container = document.getElementById('staffDataTable');
        // Sort: Shift terbaru di atas
        const sorted = data.sort((a,b) => b.timestamp - a.timestamp);
        container.innerHTML = sorted.length ? sorted.map(l => {
            const diff = (l.difference || 0);
            const diffColor = diff < 0 ? 'text-red-500' : (diff > 0 ? 'text-green-500' : 'text-gray-500');
            return `<tr>
                <td>${new Date(l.timestamp).toLocaleDateString('id-ID')}</td>
                <td><span style="background:${l.shift.includes('Pagi')?'#feebc8':l.shift.includes('Siang')?'#bee3f8':'#e9d8fd'}; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:700;">${l.shift}</span></td>
                <td>${l.staffName}</td>
                <td>${formatRupiah(l.startCash)}</td>
                <td>${formatRupiah(l.physicalCash)}</td>
                <td class="${diffColor} font-bold">${formatRupiah(diff)}</td>
                <td>
                    <button class="action-btn-sm btn-edit" onclick="window.triggerEdit('${l.id}')">Edit</button>
                    <button class="action-btn-sm btn-delete" onclick="window.triggerDelete('${l.id}')">Hapus</button>
                </td>
            </tr>`;
        }).join('') : '<tr><td colspan="7" class="empty-state">Kosong</td></tr>';
    }

    function updateVoidList(data) {
        const container = document.getElementById('voidList');
        container.innerHTML = data.length ? data.map(v => `
            <div style="padding:10px; border-bottom:1px solid #edf2f7;">
                <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:700; color:#e53e3e;">
                    <span>Meja ${v.table} - ${v.customer}</span>
                    <span>${formatRupiah(v.total)}</span>
                </div>
                <div style="font-size:12px; color:#718096;">Alasan: ${v.voidReason || '-'}</div>
            </div>
        `).join('') : '<div class="empty-state">Aman</div>';
    }

    // --- Edit & Delete Logic ---
    window.triggerEdit = (id) => {
        const r = allShiftReports.find(x => x.id === id);
        if(!r) return;
        currentEditRecordId = id;
        let s = r.shift.includes('Pagi')?'Pagi':r.shift.includes('Siang')?'Siang':'Malam';
        document.getElementById('edit-shift').value = s;
        document.getElementById('edit-staff').value = r.staffName;
        document.getElementById('edit-modal').value = r.startCash;
        document.getElementById('edit-fisik').value = r.physicalCash;
        document.getElementById('editModal').classList.add('active');
    };

    window.closeEditModal = () => { document.getElementById('editModal').classList.remove('active'); currentEditRecordId=null; };

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(!currentEditRecordId) return;
        const start = parseInt(document.getElementById('edit-modal').value)||0;
        const fisik = parseInt(document.getElementById('edit-fisik').value)||0;
        const r = allShiftReports.find(x => x.id === currentEditRecordId);
        const expected = start + (r.cashSales||0) - (r.expenses||0);

        try {
            await updateDoc(doc(db, 'shift_reports', currentEditRecordId), {
                shift: document.getElementById('edit-shift').value,
                staffName: document.getElementById('edit-staff').value,
                startCash: start, physicalCash: fisik, expectedCash: expected, difference: fisik - expected
            });
            closeEditModal();
        } catch(err) { alert("Error: " + err.message); }
    });

    window.triggerDelete = async (id) => {
        if(confirm("Hapus permanen?")) {
            try { await deleteDoc(doc(db, 'shift_reports', id)); } catch(e){ alert("Gagal hapus"); }
        }
    };

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); currentFilter = btn.dataset.filter; updateDashboard();
        });
    });

    window.downloadReport = () => {
        let csv = 'Tanggal,Shift,Staff,Modal,QRIS,Cash,Bon,Fisik,Selisih\n';
        filterDataByPeriod(allShiftReports, currentFilter).forEach(r => {
            csv += `${new Date(r.timestamp).toLocaleDateString()},${r.shift},${r.staffName},${r.startCash},${r.qrisSales},${r.cashSales},${r.expenses},${r.physicalCash},${r.difference}\n`;
        });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `Laporan_${currentFilter}.csv`; a.click();
    };

    function formatRupiah(n) { return 'Rp ' + (n||0).toLocaleString('id-ID'); }
  </script>
 </body>
</html>
