<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard - Secure Access</title>
  <!-- Chart.js & Tailwind -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; width: 100%;
    }
    * { box-sizing: border-box; }

    .dashboard-container { width: 100%; min-height: 100%; padding: 24px; max-width: 1200px; margin: 0 auto; display: none; /* Hidden by default */ }

    /* Login Overlay Styles */
    #auth-overlay {
      position: fixed; inset: 0; background: #f7fafc; z-index: 2000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .login-box {
      background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      width: 90%; max-width: 350px; text-align: center;
    }
    .login-input {
        width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; 
        border-radius: 10px; font-size: 14px; outline: none; transition: border 0.3s;
    }
    .login-input:focus { border-color: #667eea; }
    .login-btn {
        width: 100%; padding: 12px; background: #667eea; color: white; border-radius: 10px; 
        font-weight: 700; border: none; cursor: pointer; transition: background 0.3s;
    }
    .login-btn:hover { background: #5a67d8; }

    /* Dashboard Components */
    .header { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .header h1 { margin: 0; color: #1a202c; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
    .header p { margin: 0; color: #718096; font-size: 14px; font-weight: 500; }

    .filter-section { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 10px; border-radius: 12px; margin-bottom: 24px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .filter-btn { padding: 10px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #4a5568; transition: all 0.2s ease; }
    .filter-btn:hover { background: #edf2f7; color: #2d3748; }
    .filter-btn.active { background: white; color: #667eea; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    .download-btn { padding: 10px 20px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; margin-left: auto; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3); }
    .download-btn:hover { transform: translateY(-2px); }

    .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: transform 0.2s; }
    .card:hover { transform: translateY(-2px); }
    .card h3 { margin: 0 0 20px 0; color: #2d3748; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #f7fafc; padding-bottom: 10px; }
    .chart-container { position: relative; height: 250px; width: 100%; }

    .top-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #667eea; margin-bottom: 8px; }
    .top-item-name { font-weight: 600; color: #2d3748; font-size: 14px; }
    .top-item-count { font-weight: 800; color: #667eea; font-size: 15px; background: #ebf4ff; padding: 4px 8px; border-radius: 6px; }

    .basket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .basket-item { padding: 12px; background: linear-gradient(135deg, #fdfbf7 0%, #fff 100%); border: 1px solid #e2e8f0; border-radius: 10px; text-align: center; font-size: 12px; color: #4a5568; font-weight: 600; }

    .shift-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .shift-card { padding: 20px; border-radius: 16px; color: white; position: relative; overflow: hidden; }
    .shift-pagi { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
    .shift-siang { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #1a202c !important; }
    .shift-siang h4, .shift-siang .shift-total { color: #2d3748; }
    .shift-malam { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
    .shift-card h4 { margin: 0 0 15px 0; font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
    .shift-info { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 500; opacity: 0.9; }
    .shift-total { font-size: 28px; font-weight: 800; margin-top: 15px; }

    .stock-items { display: flex; flex-wrap: wrap; gap: 10px; }
    .stock-item { padding: 10px 16px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 30px; display: flex; align-items: center; gap: 8px; }
    .stock-item-name { font-weight: 600; color: #c53030; font-size: 13px; }
    .stock-item-qty { background: #c53030; color: white; font-weight: 700; font-size: 12px; padding: 2px 8px; border-radius: 10px; }

    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table thead { background: #f7fafc; }
    .data-table th { padding: 14px; text-align: left; font-weight: 600; color: #4a5568; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0; }
    .data-table td { padding: 14px; border-bottom: 1px solid #edf2f7; color: #2d3748; font-size: 14px; }
    .data-table tr:hover { background-color: #f8fafc; }

    .empty-state { text-align: center; color: #a0aec0; padding: 30px; font-style: italic; font-size: 14px; }
    
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .download-btn { width: 100%; margin-top: 10px; text-align: center; }
      .filter-section { justify-content: center; }
    }
  </style>
 </head>
 <body>

  <!-- AUTH OVERLAY (Login Screen) -->
  <div id="auth-overlay">
      <div class="login-box">
          <h2 style="font-size:24px; font-weight:800; color:#2d3748; margin-bottom:8px;">Manager Access</h2>
          <p style="color:#718096; margin-bottom:24px; font-size:14px;">Login untuk melihat data keuangan.</p>
          
          <form onsubmit="handleLogin(event)">
              <input type="email" id="mgr-email" placeholder="Email Manager" class="login-input" required>
              <input type="password" id="mgr-pass" placeholder="Password" class="login-input" required>
              <button type="submit" id="btn-login" class="login-btn">Masuk Dashboard</button>
          </form>
          <p id="login-error" style="margin-top:15px; color:#e53e3e; font-size:13px; display:none;"></p>
      </div>
  </div>

  <!-- DASHBOARD CONTENT -->
  <div id="dashboard-ui" class="dashboard-container">
   <div class="header">
    <div>
        <h1>üìä Manager Dashboard</h1>
        <p>Data Real-time dari POS & Staff App</p>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="doLogout()" style="padding:10px; background:#e2e8f0; color:#4a5568; border-radius:8px; font-weight:600;">Logout</button>
        <button class="download-btn" onclick="downloadReport()">üì• Download Laporan</button>
    </div>
   </div>

   <div class="filter-section">
    <button class="filter-btn active" data-filter="today">Hari Ini (Operational)</button>
    <button class="filter-btn" data-filter="week">Minggu Ini</button>
    <button class="filter-btn" data-filter="month">Bulan Ini</button>
   </div>

   <div class="analytics-grid">
    <!-- Peak Hour -->
    <div class="card">
     <h3>üìà Analisis Jam Sibuk (Data POS)</h3>
     <div class="chart-container"><canvas id="peakHourChart"></canvas></div>
    </div>
    
    <!-- Top Menu -->
    <div class="card">
     <h3>üçΩÔ∏è Menu Terlaris (Data POS)</h3>
     <div id="topItemsList"><div class="empty-state">Menunggu data...</div></div>
    </div>
    
    <!-- Market Basket -->
    <div class="card">
     <h3>üõí Kombinasi Menu Favorit</h3>
     <div id="basketAnalysis" class="basket-grid"><div class="empty-state">Belum ada pola...</div></div>
    </div>
   </div>

   <div class="card" style="background: transparent; box-shadow: none; padding: 0;">
    <h3 style="margin-bottom: 16px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üí∞ Monitoring Shift (Hari Ini)</h3>
    <div class="shift-cards" id="shiftCards">
     <div class="shift-card shift-pagi">
      <h4>üåÖ Shift Pagi (08:00-15:59)</h4>
      <div class="shift-info"><span>QRIS</span> <span id="pagi-qris">Rp 0</span></div>
      <div class="shift-info"><span>Cash</span> <span id="pagi-cash">Rp 0</span></div>
      <div class="shift-total" id="pagi-total">Rp 0</div>
     </div>
     <div class="shift-card shift-siang">
      <h4>üåÜ Shift Siang (16:00-22:59)</h4>
      <div class="shift-info"><span>QRIS</span> <span id="siang-qris">Rp 0</span></div>
      <div class="shift-info"><span>Cash</span> <span id="siang-cash">Rp 0</span></div>
      <div class="shift-total" id="siang-total">Rp 0</div>
     </div>
     <div class="shift-card shift-malam">
      <h4>üåô Shift Malam (23:00-07:59)</h4>
      <div class="shift-info"><span>QRIS</span> <span id="malam-qris">Rp 0</span></div>
      <div class="shift-info"><span>Cash</span> <span id="malam-cash">Rp 0</span></div>
      <div class="shift-total" id="malam-total">Rp 0</div>
     </div>
    </div>
   </div>

   <div class="analytics-grid" style="margin-top: 24px;">
       <div class="card">
        <h3>‚ö†Ô∏è Stok Menipis (< 5 Unit)</h3>
        <div id="stockAlerts" class="stock-items"><div class="empty-state">Semua stok aman</div></div>
       </div>
       
       <div class="card">
        <h3>üö´ Log Pembatalan (Void)</h3>
        <div id="voidList" style="max-height: 200px; overflow-y: auto;">
            <div class="empty-state">Tidak ada pembatalan</div>
        </div>
       </div>
   </div>

   <div class="card">
    <h3>üë• Laporan Tutup Shift (Dari Staff App)</h3>
    <div class="table-container">
     <table class="data-table">
      <thead>
       <tr><th>Tanggal</th><th>Shift</th><th>Staff</th><th>Modal</th><th>Fisik Laci</th><th>Selisih</th></tr>
      </thead>
      <tbody id="staffDataTable">
       <tr><td colspan="6" class="empty-state">Belum ada data shift</td></tr>
      </tbody>
     </table>
    </div>
   </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // CONFIG FIREBASE ASLI ANDA
    const firebaseConfig = {
      apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
      authDomain: "payboss-cafe-system.firebaseapp.com",
      projectId: "payboss-cafe-system",
      storageBucket: "payboss-cafe-system.firebasestorage.app",
      messagingSenderId: "570523503793",
      appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
      measurementId: "G-H1NJ369HE9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // State
    let allCompletedOrders = [], allShiftReports = [], allInventory = [], allVoided = [];
    let currentFilter = 'today';
    let peakHourChart = null;
    let unsubscribeList = [];

    // AUTH LISTENER
    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('auth-overlay');
        const dashboard = document.getElementById('dashboard-ui');
        
        if (user) {
            // Jika user login: Sembunyikan login, tampilkan dashboard, mulai tarik data
            overlay.style.display = 'none';
            dashboard.style.display = 'block';
            setupRealtimeListeners(); 
        } else {
            // Jika user logout: Tampilkan login, sembunyikan dashboard
            overlay.style.display = 'flex';
            dashboard.style.display = 'none';
            unsubscribeAll(); // Stop tarik data
        }
    });

    // LOGIN LOGIC
    window.handleLogin = async (e) => {
        e.preventDefault();
        const email = document.getElementById('mgr-email').value;
        const pass = document.getElementById('mgr-pass').value;
        const btn = document.getElementById('btn-login');
        const err = document.getElementById('login-error');

        btn.textContent = "Memproses...";
        btn.disabled = true;
        err.style.display = 'none';

        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // onAuthStateChanged akan handle sisanya
        } catch (error) {
            console.error(error);
            err.textContent = "Login Gagal: Email/Password salah.";
            err.style.display = 'block';
            btn.textContent = "Masuk Dashboard";
            btn.disabled = false;
        }
    };

    window.doLogout = () => signOut(auth);

    // DATA LISTENERS
    function unsubscribeAll() {
        unsubscribeList.forEach(unsub => unsub());
        unsubscribeList = [];
    }

    function setupRealtimeListeners() {
        unsubscribeAll(); // Bersihkan listener lama jika ada

        // 1. Completed Orders
        const unsub1 = onSnapshot(collection(db, "completedOrders"), (snapshot) => {
            allCompletedOrders = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().createdAt?.seconds * 1000}));
            updateDashboard();
        }, (error) => console.warn("Auth Permission Error (Orders)", error));

        // 2. Shift Reports
        const unsub2 = onSnapshot(collection(db, "shift_reports"), (snapshot) => {
            allShiftReports = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().createdAt?.seconds * 1000}));
            updateDashboard();
        }, (error) => console.warn("Auth Permission Error (Shift)", error));

        // 3. Inventory
        const qKitchen = query(collection(db, "inventory_kitchen"));
        const unsub3 = onSnapshot(qKitchen, (snapK) => {
            const kItems = snapK.docs.map(d => ({...d.data(), type: 'Dapur'}));
            // Bar fetched once here for simplicity in snapshot flow
            getDocs(collection(db, "inventory_bar")).then(snapB => {
                const bItems = snapB.docs.map(d => ({...d.data(), type: 'Bar'}));
                allInventory = [...kItems, ...bItems];
                updateDashboard();
            });
        });

        // 4. Void Logs
        const unsub4 = onSnapshot(collection(db, "voidedOrders"), (snapshot) => {
            allVoided = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().voidedAt?.seconds * 1000}));
            updateDashboard();
        });

        unsubscribeList.push(unsub1, unsub2, unsub3, unsub4);
    }

    // DASHBOARD LOGIC (Business Day)
    function getBusinessDate(timestamp) {
        const d = new Date(timestamp);
        if (d.getHours() < 8) d.setDate(d.getDate() - 1);
        d.setHours(0, 0, 0, 0);
        return d.getTime();
    }

    function filterDataByPeriod(data, period) {
        const now = new Date();
        const currentBusinessDate = getBusinessDate(now.getTime());
        return data.filter(record => {
            if (!record.timestamp) return false;
            const recordBusinessDate = getBusinessDate(record.timestamp);
            if (period === 'today') return recordBusinessDate === currentBusinessDate;
            if (period === 'week') return recordBusinessDate >= (currentBusinessDate - (7 * 86400000));
            if (period === 'month') return recordBusinessDate >= (currentBusinessDate - (30 * 86400000));
            return true;
        });
    }

    function updateDashboard() {
        const fOrders = filterDataByPeriod(allCompletedOrders, currentFilter);
        const fShifts = filterDataByPeriod(allShiftReports, currentFilter);
        const fVoids = filterDataByPeriod(allVoided, currentFilter);

        updatePeakHourChart(fOrders);
        updateTopItems(fOrders);
        updateBasketAnalysis(fOrders);
        updateShiftMonitoringFromOrders(fOrders);
        updateStockAlerts(allInventory);
        updateStaffDataTable(fShifts);
        updateVoidList(fVoids);
    }

    // VISUALIZATION FUNCTIONS
    function updatePeakHourChart(data) {
        const hourData = new Array(24).fill(0);
        data.forEach(t => { if(t.timestamp) hourData[new Date(t.timestamp).getHours()] += (t.total || 0); });
        const ctx = document.getElementById('peakHourChart');
        if (peakHourChart) peakHourChart.destroy();
        peakHourChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                datasets: [{ label: 'Penjualan (Rp)', data: hourData, backgroundColor: '#667eea', borderRadius: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: {beginAtZero: true} } }
        });
    }

    function updateTopItems(data) {
        const counts = {};
        data.forEach(t => (t.items || []).forEach(i => counts[i.name] = (counts[i.name] || 0) + (i.qty || 1)));
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        const container = document.getElementById('topItemsList');
        container.innerHTML = sorted.length ? sorted.map(([n, c]) => `<div class="top-item"><span class="top-item-name">${n}</span><span class="top-item-count">${c}x</span></div>`).join('') : '<div class="empty-state">Menunggu data POS...</div>';
    }

    function updateBasketAnalysis(data) {
        const pairs = {};
        data.forEach(t => {
            const items = (t.items || []).map(i => i.name).sort();
            for(let i=0; i<items.length; i++) for(let j=i+1; j<items.length; j++) pairs[`${items[i]} + ${items[j]}`] = (pairs[`${items[i]} + ${items[j]}`] || 0) + 1;
        });
        const sorted = Object.entries(pairs).sort((a,b) => b[1] - a[1]).slice(0, 4);
        const container = document.getElementById('basketAnalysis');
        container.innerHTML = sorted.length ? sorted.map(([c, n]) => `<div class="basket-item">${c} (${n})</div>`).join('') : '<div class="empty-state">Belum ada pola</div>';
    }

    function updateShiftMonitoringFromOrders(data) {
        const totals = { Pagi: {q:0, c:0}, Siang: {q:0, c:0}, Malam: {q:0, c:0} };
        data.forEach(o => {
            const h = new Date(o.timestamp).getHours();
            let s = 'Malam'; // Default malam (23-07)
            if (h >= 8 && h < 16) s = 'Pagi';
            else if (h >= 16 && h < 23) s = 'Siang';
            
            const method = (o.paymentMethod || 'cash').toLowerCase();
            if(method.includes('qris') || method.includes('transfer')) totals[s].q += (o.total||0);
            else totals[s].c += (o.total||0);
        });
        ['pagi','siang','malam'].forEach(k => {
            const Key = k.charAt(0).toUpperCase() + k.slice(1);
            document.getElementById(`${k}-qris`).textContent = formatRupiah(totals[Key].q);
            document.getElementById(`${k}-cash`).textContent = formatRupiah(totals[Key].c);
            document.getElementById(`${k}-total`).textContent = formatRupiah(totals[Key].q + totals[Key].c);
        });
    }

    function updateStockAlerts(data) {
        const low = data.filter(i => (i.stock||0) < 5);
        const container = document.getElementById('stockAlerts');
        container.innerHTML = low.length ? low.map(i => `<div class="stock-item"><span class="stock-item-name">${i.name}</span><span class="stock-item-qty">${i.stock}</span></div>`).join('') : '<div class="empty-state">Aman</div>';
    }

    function updateStaffDataTable(data) {
        const container = document.getElementById('staffDataTable');
        const sorted = data.sort((a,b) => b.timestamp - a.timestamp);
        container.innerHTML = sorted.length ? sorted.map(l => {
            const diff = (l.difference || 0);
            const diffColor = diff < 0 ? 'text-red-500' : (diff > 0 ? 'text-green-500' : 'text-gray-500');
            return `<tr>
                <td>${new Date(l.timestamp).toLocaleDateString('id-ID')}</td>
                <td><span style="background:${l.shift.includes('Pagi')?'#feebc8':l.shift.includes('Siang')?'#bee3f8':'#e9d8fd'}; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:700;">${l.shift}</span></td>
                <td>${l.staffName}</td>
                <td>${formatRupiah(l.startCash)}</td>
                <td>${formatRupiah(l.physicalCash)}</td>
                <td class="${diffColor} font-bold">${formatRupiah(diff)}</td>
            </tr>`;
        }).join('') : '<tr><td colspan="6" class="empty-state">Kosong</td></tr>';
    }

    function updateVoidList(data) {
        const container = document.getElementById('voidList');
        container.innerHTML = data.length ? data.map(v => `
            <div style="padding:10px; border-bottom:1px solid #edf2f7;">
                <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:700; color:#e53e3e;">
                    <span>Meja ${v.table} - ${v.customer}</span>
                    <span>${formatRupiah(v.total)}</span>
                </div>
                <div style="font-size:12px; color:#718096;">Alasan: ${v.voidReason || '-'}</div>
            </div>
        `).join('') : '<div class="empty-state">Aman</div>';
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); currentFilter = btn.dataset.filter; updateDashboard();
        });
    });

    window.downloadReport = () => {
        let csv = 'Tanggal,Shift,Staff,Modal,QRIS,Cash,Bon,Fisik,Selisih\n';
        filterDataByPeriod(allShiftReports, currentFilter).forEach(r => {
            csv += `${new Date(r.timestamp).toLocaleDateString()},${r.shift},${r.staffName},${r.startCash},${r.qrisSales},${r.cashSales},${r.expenses},${r.physicalCash},${r.difference}\n`;
        });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `Laporan_${currentFilter}.csv`; a.click();
    };

    function formatRupiah(n) { return 'Rp ' + (n||0).toLocaleString('id-ID'); }
  </script>
 </body>
</html>
