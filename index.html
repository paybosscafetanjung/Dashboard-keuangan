<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payboss - Dashboard Keuangan & Laporan Shift</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        /* Badge Shift */
        .badge-s1 { background: #FEF3C7; color: #92400E; border: 1px solid #F59E0B; }
        .badge-s2 { background: #FFEDD5; color: #9A3412; border: 1px solid #EA580C; }
        .badge-s3 { background: #DBEAFE; color: #1E3A8A; border: 1px solid #2563EB; }
    </style>
</head>
<body class="p-6 min-h-screen relative pb-20">

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üîí Akses Manager</h2>
                <p class="text-gray-500 text-sm">Login staff untuk akses data.</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Gagal login.</div>
                <button type="submit" id="btn-login" class="w-full py-2 px-4 bg-blue-900 text-white rounded-md font-bold hover:bg-blue-800">Masuk</button>
            </form>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content" class="filter blur-sm pointer-events-none transition duration-500 max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">üìä Laporan & Closing</h1>
                <p class="text-gray-600">Pantau Performa Tiap Shift Hari Ini</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow text-right">
                    <span class="text-xs text-gray-500 block">Tanggal:</span>
                    <span id="header-date" class="font-bold text-gray-800 text-sm">...</span>
                </div>
                <button id="btn-logout" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 text-sm font-bold">Keluar</button>
            </div>
        </div>

        <!-- BAGIAN 1: RINGKASAN PENDAPATAN PER SHIFT (BARU) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            
            <!-- Card Shift 1 -->
            <div class="bg-white rounded-xl shadow-lg border-t-4 border-yellow-500 p-6 card relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-gray-700 text-lg">‚òÄÔ∏è Shift 1 (Pagi)</h3>
                        <p class="text-xs text-gray-400">08:00 - 16:00</p>
                    </div>
                    <span class="badge-s1 px-2 py-1 rounded text-xs font-bold">PAGI</span>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Total Omset</p>
                    <p id="s1-total" class="text-2xl font-bold text-gray-800">Rp 0</p>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm border-t pt-3">
                    <div>
                        <p class="text-gray-400 text-xs">Cash</p>
                        <p id="s1-cash" class="font-bold text-yellow-700">Rp 0</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">QRIS</p>
                        <p id="s1-qris" class="font-bold text-green-600">Rp 0</p>
                    </div>
                </div>
            </div>

            <!-- Card Shift 2 -->
            <div class="bg-white rounded-xl shadow-lg border-t-4 border-orange-500 p-6 card relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-gray-700 text-lg">üå§Ô∏è Shift 2 (Sore)</h3>
                        <p class="text-xs text-gray-400">16:00 - 00:00</p>
                    </div>
                    <span class="badge-s2 px-2 py-1 rounded text-xs font-bold">SORE</span>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Total Omset</p>
                    <p id="s2-total" class="text-2xl font-bold text-gray-800">Rp 0</p>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm border-t pt-3">
                    <div>
                        <p class="text-gray-400 text-xs">Cash</p>
                        <p id="s2-cash" class="font-bold text-orange-700">Rp 0</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">QRIS</p>
                        <p id="s2-qris" class="font-bold text-green-600">Rp 0</p>
                    </div>
                </div>
            </div>

            <!-- Card Shift 3 -->
            <div class="bg-white rounded-xl shadow-lg border-t-4 border-blue-600 p-6 card relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-gray-700 text-lg">üåô Shift 3 (Malam)</h3>
                        <p class="text-xs text-gray-400">00:00 - 08:00</p>
                    </div>
                    <span class="badge-s3 px-2 py-1 rounded text-xs font-bold">MALAM</span>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Total Omset</p>
                    <p id="s3-total" class="text-2xl font-bold text-gray-800">Rp 0</p>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm border-t pt-3">
                    <div>
                        <p class="text-gray-400 text-xs">Cash</p>
                        <p id="s3-cash" class="font-bold text-blue-700">Rp 0</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">QRIS</p>
                        <p id="s3-qris" class="font-bold text-green-600">Rp 0</p>
                    </div>
                </div>
            </div>
        </div>

        <hr class="border-gray-300 mb-8 border-dashed">

        <!-- BAGIAN 2: FILTER & REKONSILIASI (YANG LAMA) -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4">üßÆ Area Closing Kasir</h2>
        
        <div class="bg-white p-4 rounded-xl shadow mb-6 border-l-4 border-indigo-500">
            <h3 class="font-bold text-gray-700 mb-3">‚è±Ô∏è Pilih Shift untuk Rekonsiliasi</h3>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                <button onclick="setShift('08:00', '16:00', 'Shift 1 (Pagi)')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 py-3 px-4 rounded-lg font-bold transition text-sm border border-yellow-200">‚òÄÔ∏è Shift 1</button>
                <button onclick="setShift('16:00', '23:59', 'Shift 2 (Sore)')" class="bg-orange-100 hover:bg-orange-200 text-orange-800 py-3 px-4 rounded-lg font-bold transition text-sm border border-orange-200">üå§Ô∏è Shift 2</button>
                <button onclick="setShift('00:00', '08:00', 'Shift 3 (Malam)')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 py-3 px-4 rounded-lg font-bold transition text-sm border border-blue-200">üåô Shift 3</button>
                <button onclick="setShift('00:00', '23:59', 'Semua Shift')" class="bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 px-4 rounded-lg font-bold transition text-sm border border-gray-200">üìÖ Full Day</button>
            </div>
            
            <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-lg hidden"> <!-- Hidden karena otomatis by button -->
                <input type="time" id="filter-start-time"><input type="time" id="filter-end-time">
            </div>
        </div>

        <!-- KALKULATOR -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden mb-8">
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">üßÆ Cek Selisih: <span id="active-shift-label" class="text-yellow-400">Pilih Shift Diatas</span></h2>
                <button onclick="resetCalculator()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">Reset</button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
                <!-- KOLOM 1: INPUT -->
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-700 border-b pb-2">1. Uang Fisik</h3>
                    <div><label class="block text-sm font-bold text-gray-600 mb-1">Modal Awal</label><input type="number" id="input-modal-awal" oninput="calculateClosing()" class="w-full p-3 border rounded-lg text-right font-mono" placeholder="0"></div>
                    <div><label class="block text-sm font-bold text-gray-600 mb-1">Total Laci (Akhir)</label><input type="number" id="input-fisik-akhir" oninput="calculateClosing()" class="w-full p-3 border-2 border-blue-500 rounded-lg text-right font-mono font-bold text-lg" placeholder="0"></div>
                    <div><label class="block text-sm font-bold text-gray-600 mb-1">Bon/Pengeluaran</label><input type="number" id="input-pengeluaran" oninput="calculateClosing()" class="w-full p-3 border rounded-lg text-right font-mono text-orange-600" placeholder="0"></div>
                </div>
                <!-- KOLOM 2: SISTEM -->
                <div class="bg-gray-50 p-4 rounded-xl border">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">2. Data Sistem</h3>
                    <div class="flex justify-between mb-2"><span class="text-gray-600">Cash:</span><span id="system-cash-display" class="font-bold text-gray-800">Rp 0</span></div>
                    <div class="flex justify-between mb-4"><span class="text-gray-600">QRIS:</span><span id="system-qris-display" class="font-bold text-green-600">Rp 0</span></div>
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center"><span class="font-bold text-gray-700">Pendapatan Fisik:</span><span id="calculated-physical-revenue" class="font-bold text-blue-600 text-lg">Rp 0</span></div>
                    </div>
                </div>
                <!-- KOLOM 3: HASIL -->
                <div class="text-center flex flex-col justify-center h-full">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-6">3. Selisih</h3>
                    <div id="result-box" class="p-6 rounded-2xl border-4 border-gray-200 bg-gray-50">
                        <p class="text-gray-500 font-bold uppercase text-sm mb-2">Variance</p>
                        <div id="variance-amount" class="text-4xl font-black text-gray-800 mb-2">Rp 0</div>
                        <div id="variance-status" class="inline-block px-4 py-1 rounded-full text-sm font-bold bg-gray-200 text-gray-600">Belum Input</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabel Riwayat -->
        <div class="bg-white p-6 rounded-xl shadow overflow-hidden">
            <h3 class="font-bold text-gray-700 mb-4">Rincian Transaksi (Shift Terpilih)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-100 text-gray-600 border-b">
                        <tr><th class="py-3 px-4">Jam</th><th class="py-3 px-4">Pelanggan</th><th class="py-3 px-4">Metode</th><th class="py-3 px-4 text-right">Total</th></tr>
                    </thead>
                    <tbody id="transaction-list" class="divide-y divide-gray-200">
                        <tr><td colspan="4" class="py-4 text-center text-gray-400">Menunggu data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
            authDomain: "payboss-cafe-system.firebaseapp.com",
            projectId: "payboss-cafe-system",
            storageBucket: "payboss-cafe-system.appspot.com",
            messagingSenderId: "570523503793",
            appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
            measurementId: "G-H1NJ369HE9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allOrdersToday = [];
        let systemCashTotal = 0;
        let unsubscribeOrders = null;

        // AUTH
        const loginModal = document.getElementById('login-modal');
        const mainContent = document.getElementById('main-content');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginModal.classList.add('hidden');
                mainContent.classList.remove('filter', 'blur-sm', 'pointer-events-none');
                listenToDailyOrders();
            } else {
                loginModal.classList.remove('hidden');
                mainContent.classList.add('filter', 'blur-sm', 'pointer-events-none');
                if (unsubscribeOrders) unsubscribeOrders();
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            btn.textContent = "Memproses..."; btn.disabled = true;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { document.getElementById('login-error').classList.remove('hidden'); btn.textContent = "Masuk"; btn.disabled = false; }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        // FETCH DATA
        function listenToDailyOrders() {
            const today = new Date();
            today.setHours(0,0,0,0);
            document.getElementById('header-date').textContent = today.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
            
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));

            unsubscribeOrders = onSnapshot(q, (snapshot) => {
                allOrdersToday = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!data.createdAt) return;
                    const orderDate = data.createdAt.toDate();
                    if (orderDate.setHours(0,0,0,0) === today.getTime()) {
                        allOrdersToday.push({
                            ...data,
                            formattedTime: doc.data().createdAt.toDate().toLocaleTimeString('id-ID', {hour12: false, hour: '2-digit', minute:'2-digit'}),
                            rawDate: doc.data().createdAt.toDate()
                        });
                    }
                });

                // 1. UPDATE SUMMARY CARDS (FITUR BARU)
                updateShiftSummaries();

                // 2. APPLY FILTER EXISTING (DEFAULT FULL DAY)
                if(!document.getElementById('filter-start-time').value) {
                    setShift('00:00', '23:59', 'Semua Shift');
                } else {
                    applyFilter();
                }

            }, (error) => {
                if (error.code === 'permission-denied') alert("Izin Ditolak! Pastikan login.");
            });
        }

        // FUNGSI BARU: HITUNG RINGKASAN 3 SHIFT
        function updateShiftSummaries() {
            // Inisialisasi Penampung
            let s1 = { total: 0, cash: 0, qris: 0 };
            let s2 = { total: 0, cash: 0, qris: 0 };
            let s3 = { total: 0, cash: 0, qris: 0 };

            allOrdersToday.forEach(order => {
                const time = order.formattedTime; // "14:30"
                const amount = order.total || 0;
                const isQris = (order.paymentMethod || '').toLowerCase().includes('qris');

                // Logika Pembagian Shift
                if (time >= '08:00' && time <= '16:00') {
                    // Shift 1
                    s1.total += amount;
                    if(isQris) s1.qris += amount; else s1.cash += amount;
                } else if (time > '16:00' && time <= '23:59') {
                    // Shift 2
                    s2.total += amount;
                    if(isQris) s2.qris += amount; else s2.cash += amount;
                } else if (time >= '00:00' && time < '08:00') {
                    // Shift 3
                    s3.total += amount;
                    if(isQris) s3.qris += amount; else s3.cash += amount;
                }
            });

            // Update UI Card Shift 1
            document.getElementById('s1-total').textContent = `Rp ${s1.total.toLocaleString('id-ID')}`;
            document.getElementById('s1-cash').textContent = `Rp ${s1.cash.toLocaleString('id-ID')}`;
            document.getElementById('s1-qris').textContent = `Rp ${s1.qris.toLocaleString('id-ID')}`;

            // Update UI Card Shift 2
            document.getElementById('s2-total').textContent = `Rp ${s2.total.toLocaleString('id-ID')}`;
            document.getElementById('s2-cash').textContent = `Rp ${s2.cash.toLocaleString('id-ID')}`;
            document.getElementById('s2-qris').textContent = `Rp ${s2.qris.toLocaleString('id-ID')}`;

            // Update UI Card Shift 3
            document.getElementById('s3-total').textContent = `Rp ${s3.total.toLocaleString('id-ID')}`;
            document.getElementById('s3-cash').textContent = `Rp ${s3.cash.toLocaleString('id-ID')}`;
            document.getElementById('s3-qris').textContent = `Rp ${s3.qris.toLocaleString('id-ID')}`;
        }

        // FILTER LOGIC
        window.setShift = function(start, end, label) {
            document.getElementById('filter-start-time').value = start;
            document.getElementById('filter-end-time').value = end;
            document.getElementById('active-shift-label').textContent = label;
            applyFilter();
        }

        window.applyFilter = function() {
            const startStr = document.getElementById('filter-start-time').value;
            const endStr = document.getElementById('filter-end-time').value;
            if(!startStr || !endStr) return;

            const filteredOrders = allOrdersToday.filter(order => {
                const time = order.formattedTime;
                return time >= startStr && time <= endStr;
            });
            renderFilteredData(filteredOrders);
        }

        function renderFilteredData(orders) {
            let totalRev = 0, qrisRev = 0, cashRev = 0;
            const tableBody = document.getElementById('transaction-list');
            tableBody.innerHTML = ''; 

            if(orders.length === 0) tableBody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-400 italic">Tidak ada transaksi di jam ini</td></tr>';

            orders.forEach(data => {
                const amount = data.total || 0;
                totalRev += amount;
                const method = (data.paymentMethod || 'unknown').toLowerCase();
                if (method.includes('qris')) { qrisRev += amount; } else { cashRev += amount; }
                const badgeColor = method.includes('qris') ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                tableBody.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="py-3 px-4 text-gray-500 text-xs">${data.formattedTime}</td><td class="py-3 px-4 font-semibold text-gray-700">${data.customer || '-'}</td><td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeColor}">${data.paymentMethod}</span></td><td class="py-3 px-4 text-right font-bold text-gray-700">Rp ${amount.toLocaleString('id-ID')}</td></tr>`;
            });

            systemCashTotal = cashRev;
            document.getElementById('system-cash-display').textContent = `Rp ${cashRev.toLocaleString('id-ID')}`;
            document.getElementById('system-qris-display').textContent = `Rp ${qrisRev.toLocaleString('id-ID')}`;
            calculateClosing();
        }

        window.calculateClosing = function() {
            const modalAwal = parseFloat(document.getElementById('input-modal-awal').value) || 0;
            const fisikAkhir = parseFloat(document.getElementById('input-fisik-akhir').value) || 0;
            const pengeluaran = parseFloat(document.getElementById('input-pengeluaran').value) || 0;
            const pendapatanFisik = (fisikAkhir - modalAwal) + pengeluaran;
            const selisih = pendapatanFisik - systemCashTotal;

            document.getElementById('calculated-physical-revenue').textContent = `Rp ${pendapatanFisik.toLocaleString('id-ID')}`;
            const varianceBox = document.getElementById('result-box');
            const varianceAmt = document.getElementById('variance-amount');
            const varianceSts = document.getElementById('variance-status');

            varianceAmt.textContent = `Rp ${selisih.toLocaleString('id-ID')}`;
            if (document.getElementById('input-fisik-akhir').value === '') {
                varianceBox.className = "p-6 rounded-2xl border-4 border-gray-200 bg-gray-50"; varianceAmt.className = "text-4xl font-black text-gray-400 mb-2"; varianceSts.textContent = "Menunggu Input..."; varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-gray-200 text-gray-500";
            } else if (selisih === 0) {
                varianceBox.className = "p-6 rounded-2xl border-4 border-green-500 bg-green-50"; varianceAmt.className = "text-4xl font-black text-green-600 mb-2"; varianceSts.textContent = "‚úÖ KLOP"; varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-green-200 text-green-800";
            } else if (selisih < 0) {
                varianceBox.className = "p-6 rounded-2xl border-4 border-red-500 bg-red-50"; varianceAmt.className = "text-4xl font-black text-red-600 mb-2"; varianceSts.textContent = "‚ö†Ô∏è MINUS"; varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-red-200 text-red-800";
            } else {
                varianceBox.className = "p-6 rounded-2xl border-4 border-blue-500 bg-blue-50"; varianceAmt.className = "text-4xl font-black text-blue-600 mb-2"; varianceSts.textContent = "‚ÑπÔ∏è SURPLUS"; varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-blue-200 text-blue-800";
            }
        }
        window.resetCalculator = function() { document.getElementById('input-modal-awal').value = ''; document.getElementById('input-fisik-akhir').value = ''; document.getElementById('input-pengeluaran').value = ''; calculateClosing(); }
    </script>
</body>
</html>
