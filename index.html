<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard & Finance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #667eea; min-height: 100vh; }
    * { box-sizing: border-box; }

    /* Layout */
    .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
    
    /* Login Overlay */
    #auth-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 50; display: flex; justify-content: center; align-items: center; }
    .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; text-align: center; }
    .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 15px; outline: none; transition: border 0.3s; }
    .input-field:focus { border-color: #6366f1; }
    .btn-primary { width: 100%; padding: 12px; background: #4f46e5; color: white; border-radius: 10px; font-weight: 700; transition: background 0.3s; }
    .btn-primary:hover { background: #4338ca; }

    /* Navigation Tabs */
    .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 15px; backdrop-filter: blur(10px); }
    .nav-btn { flex: 1; padding: 12px; border-radius: 10px; font-weight: 700; color: white; transition: all 0.2s; text-align: center; cursor: pointer; opacity: 0.7; }
    .nav-btn.active { background: white; color: #4f46e5; opacity: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    
    /* Content Areas */
    .content-section { display: none; animation: fadeIn 0.4s ease; }
    .content-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Cards & Panels */
    .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 20px; height: 100%; }
    .card h3 { color: #334155; font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .card h3::before { content: ''; display: inline-block; width: 4px; height: 16px; background: #6366f1; border-radius: 2px; }

    /* Grid & Charts */
    .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .chart-box { height: 250px; position: relative; width: 100%; }

    /* Market Basket Grid */
    .basket-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .basket-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; font-size: 12px; color: #475569; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: center; min-height: 80px; }

    /* Shift Monitoring Cards */
    .shift-card { padding: 24px; border-radius: 16px; color: white; position: relative; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .shift-card h4 { font-size: 18px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
    .shift-pagi { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); } /* Orange */
    .shift-siang { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); } /* Green */
    .shift-malam { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); } /* Purple */
    
    .shift-row { display: flex; justify-content: space-between; font-size: 13px; font-weight: 500; margin-bottom: 6px; opacity: 0.9; }
    .shift-total { font-size: 28px; font-weight: 800; margin-top: 15px; letter-spacing: -0.5px; }

    /* Tables */
    .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    .data-table th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
    .data-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .data-table tr:hover td { background: #f8fafc; }

    /* List Items */
    .top-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
    .top-item:last-child { border-bottom: none; }
    .top-name { font-weight: 600; color: #334155; font-size: 14px; }
    .top-count { background: #eff6ff; color: #3b82f6; font-weight: 700; font-size: 12px; padding: 4px 10px; border-radius: 20px; }

    /* Finance Form */
    .finance-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #64748b; }
    .finance-select { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #e2e8f0; background: #fff; font-size: 14px; }
    
    .toast { position: fixed; bottom: 24px; right: 24px; background: #ef4444; color: white; padding: 14px 24px; border-radius: 10px; display: none; z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .toast.show { display: block; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
 </head>
 <body>

  <!-- AUTH SCREEN -->
  <div id="auth-overlay">
      <div class="login-box">
          <h2 class="text-2xl font-bold text-slate-800 mb-2">Manager Access</h2>
          <p class="text-slate-500 text-sm mb-6">Sistem Terintegrasi PayBoss</p>
          <form onsubmit="handleLogin(event)">
              <input type="email" id="mgr-email" placeholder="Email" class="input-field" required>
              <input type="password" id="mgr-pass" placeholder="Password" class="input-field" required>
              <button type="submit" id="btn-login" class="btn-primary">Masuk</button>
          </form>
          <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
      </div>
  </div>

  <!-- DASHBOARD UI -->
  <div id="dashboard-ui" class="dashboard-container">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6 text-white">
        <div>
            <h1 class="text-3xl font-extrabold tracking-tight">üìä Manager Dashboard</h1>
            <p class="text-white/80 text-sm mt-1">Monitoring Operasional & Keuangan (Semua Unit)</p>
        </div>
        <div class="flex gap-2">
            <button onclick="downloadReport()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold text-sm backdrop-blur-sm transition">üì• Download Laporan</button>
            <button onclick="doLogout()" class="bg-red-500/80 hover:bg-red-600/80 text-white px-4 py-2 rounded-lg font-bold text-sm backdrop-blur-sm transition">Logout</button>
        </div>
    </div>

    <!-- Filter Buttons -->
    <div class="flex gap-2 mb-6 bg-white p-2 rounded-xl w-fit shadow-sm">
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-indigo-100 text-indigo-700 transition" onclick="setFilter('today')" id="btn-today">Hari Ini (Ops)</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-100 transition" onclick="setFilter('week')" id="btn-week">Minggu Ini</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-100 transition" onclick="setFilter('month')" id="btn-month">Bulan Ini</button>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <div onclick="switchTab('monitoring')" class="nav-btn active" id="tab-btn-monitoring">üìà Dashboard Operasional</div>
        <div onclick="switchTab('finance')" class="nav-btn" id="tab-btn-finance">üíº Input Keuangan (Semua Unit)</div>
    </div>

    <!-- 1. MONITORING SECTION -->
    <div id="monitoring-section" class="content-section active">
        
        <div class="analytics-grid">
            <div class="card">
                <h3>üìà Analisis Jam Sibuk (Data POS)</h3>
                <div class="chart-box"><canvas id="peakHourChart"></canvas></div>
            </div>
            
            <div class="card">
                <h3>üçΩÔ∏è Menu Terlaris (Data POS)</h3>
                <div id="topItemsList" class="flex flex-col h-full overflow-y-auto max-h-[250px]">
                    <div class="text-center text-slate-400 py-10 text-sm">Menunggu data...</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üõí Kombinasi Menu Favorit</h3>
                <div id="basketAnalysis" class="basket-grid">
                    <div class="col-span-2 text-center text-slate-400 py-10 text-sm">Belum ada pola transaksi</div>
                </div>
            </div>
        </div>

        <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">üí∞ Monitoring Shift (Hari Ini)</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="shift-card shift-pagi">
                <h4>üåÖ SHIFT 1 / PAGI (00:00-08:00)</h4>
                <div class="shift-row"><span>QRIS</span> <span id="pagi-qris">Rp 0</span></div>
                <div class="shift-row"><span>Cash</span> <span id="pagi-cash">Rp 0</span></div>
                <div class="shift-total" id="pagi-total">Rp 0</div>
            </div>
            <div class="shift-card shift-siang">
                <h4>üåÜ SHIFT 2 / SIANG (08:00-16:00)</h4>
                <div class="shift-row"><span>QRIS</span> <span id="siang-qris">Rp 0</span></div>
                <div class="shift-row"><span>Cash</span> <span id="siang-cash">Rp 0</span></div>
                <div class="shift-total" id="siang-total">Rp 0</div>
            </div>
            <div class="shift-card shift-malam">
                <h4>üåô SHIFT 3 / MALAM (16:00-24:00)</h4>
                <div class="shift-row"><span>QRIS</span> <span id="malam-qris">Rp 0</span></div>
                <div class="shift-row"><span>Cash</span> <span id="malam-cash">Rp 0</span></div>
                <div class="shift-total" id="malam-total">Rp 0</div>
            </div>
        </div>
        
        <!-- NEW: TABEL RINCIAN TRANSAKSI PER SHIFT -->
        <div class="card mb-8">
            <h3>üìÑ Rincian Transaksi per Shift (Real-time POS)</h3>
            <div class="overflow-x-auto">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Shift</th>
                            <th>Meja / Pelanggan</th>
                            <th>Metode</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                        <tr><td colspan="5" class="text-center py-4 text-slate-400">Menunggu data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card h-full">
            <h3>üë• Laporan Tutup Shift (Dari Staff App)</h3>
            <div class="overflow-x-auto">
                <table class="data-table">
                    <thead><tr><th>Tanggal</th><th>Shift</th><th>Staff</th><th>Modal</th><th>Fisik</th><th>Selisih</th></tr></thead>
                    <tbody id="staffDataTable">
                        <tr><td colspan="6" class="text-center py-4 text-slate-400">Belum ada data shift</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. FINANCE SECTION -->
    <div id="finance-section" class="content-section">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 pb-2 border-b">‚ûï Input Keuangan (Semua Unit)</h3>
                    <form id="financeForm" onsubmit="submitFinance(event)">
                        <div class="finance-group mb-4">
                            <label>Kategori Transaksi</label>
                            <select id="fin-category" class="finance-select" onchange="updateFinType()">
                                <option value="" disabled selected>-- Pilih Kategori --</option>
                                <optgroup label="Biaya Tetap (Fixed Cost)">
                                    <option value="5201|Gaji Karyawan (Semua Divisi)">Gaji Karyawan</option>
                                    <option value="5300|Sewa Tempat">Sewa Tempat</option>
                                    <option value="5301|Listrik & Air">Listrik & Air</option>
                                </optgroup>
                                <optgroup label="Investasi">
                                    <option value="6101|Pembelian Aset">Pembelian Aset/Mesin</option>
                                    <option value="6106|Renovasi">Renovasi Bangunan</option>
                                </optgroup>
                                <optgroup label="Pendanaan">
                                    <option value="7101|Setor Modal">Setor Modal (Pemasukan)</option>
                                    <option value="7201|Cicilan Bank">Cicilan Bank</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="finance-group mb-4">
                            <label>Nominal (Rp)</label>
                            <input type="number" id="fin-amount" class="finance-select font-bold" placeholder="0" required>
                        </div>

                        <div class="finance-group mb-4">
                            <label>Keterangan Detail</label>
                            <textarea id="fin-note" rows="3" class="finance-select" placeholder="Contoh: Beli Mesin Kopi Baru"></textarea>
                        </div>

                        <div id="fin-type-badge" class="mb-4 text-center text-sm font-bold py-2 rounded hidden"></div>
                        <input type="hidden" id="fin-type" value="out"> 

                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-md">Simpan Transaksi</button>
                    </form>
                </div>
            </div>

            <div class="md:col-span-2">
                <div class="card h-full">
                    <h3>Riwayat Transaksi Keuangan</h3>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead><tr><th>Tanggal</th><th>Kategori</th><th>Keterangan</th><th class="text-right">Nominal</th><th>Tipe</th></tr></thead>
                            <tbody id="financeTableBody">
                                <tr><td colspan="5" class="text-center py-4 text-slate-400">Belum ada data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

  </div>
  <div id="toast" class="toast">Error Message</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, onSnapshot, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
      authDomain: "payboss-cafe-system.firebaseapp.com",
      projectId: "payboss-cafe-system",
      storageBucket: "payboss-cafe-system.firebasestorage.app",
      messagingSenderId: "570523503793",
      appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
      measurementId: "G-H1NJ369HE9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allCompletedOrders = [], allShiftReports = [], allFinanceLogs = [];
    let currentFilter = 'today';
    let peakHourChart = null;
    let unsubscribeList = [];

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('auth-overlay');
        const dashboard = document.getElementById('dashboard-ui');
        if (user) {
            overlay.style.display = 'none';
            dashboard.style.display = 'block';
            initListeners();
        } else {
            overlay.style.display = 'flex';
            dashboard.style.display = 'none';
            unsubscribeAll();
        }
    });

    window.handleLogin = async (e) => {
        e.preventDefault();
        const email = document.getElementById('mgr-email').value;
        const pass = document.getElementById('mgr-pass').value;
        const err = document.getElementById('login-error');
        const btn = document.getElementById('btn-login');
        
        btn.textContent = "Loading..."; btn.disabled = true;
        try { await signInWithEmailAndPassword(auth, email, pass); } 
        catch (e) { err.textContent = "Login Gagal: " + e.message; err.classList.remove('hidden'); btn.textContent = "Masuk"; btn.disabled = false; }
    };

    window.doLogout = () => signOut(auth);

    function unsubscribeAll() {
        unsubscribeList.forEach(unsub => unsub());
        unsubscribeList = [];
    }

    // --- DATA LISTENERS ---
    function initListeners() {
        unsubscribeAll();

        try {
            const unsub1 = onSnapshot(collection(db, "completedOrders"), (snap) => {
                allCompletedOrders = snap.docs.map(d => ({...d.data(), timestamp: d.data().createdAt?.seconds * 1000}));
                updateMonitoring();
            }, (err) => showError("Gagal memuat Data POS"));
            unsubscribeList.push(unsub1);
        } catch(e){}

        try {
            const unsub2 = onSnapshot(query(collection(db, "shift_reports"), orderBy("createdAt", "desc")), (snap) => {
                allShiftReports = snap.docs.map(d => d.data());
                renderStaffTable();
            }, (err) => showError("Gagal memuat Shift"));
            unsubscribeList.push(unsub2);
        } catch(e){}

        try {
            const unsub3 = onSnapshot(query(collection(db, "financial_transactions"), orderBy("createdAt", "desc")), (snap) => {
                allFinanceLogs = snap.docs.map(d => d.data());
                renderFinanceTable();
            }, (error) => console.warn("Finance Logs Access Denied:", error.message));
            unsubscribeList.push(unsub3);
        } catch(e) { console.warn("Init Finance Error:", e); }
    }

    // --- LOGIC ---
    function getBusinessDate(timestamp) {
        const d = new Date(timestamp);
        d.setHours(0, 0, 0, 0);
        return d.getTime();
    }

    function filterData(data, period) {
        const now = new Date();
        const currentBizDate = getBusinessDate(now.getTime());
        return data.filter(record => {
            if (!record.timestamp) return false;
            const recordBizDate = getBusinessDate(record.timestamp);
            if (period === 'today') return recordBizDate === currentBizDate;
            if (period === 'week') return recordBizDate >= (currentBizDate - (7 * 86400000));
            if (period === 'month') return recordBizDate >= (currentBizDate - (30 * 86400000));
            return true;
        });
    }

    function updateMonitoring() {
        const fOrders = filterData(allCompletedOrders, currentFilter);
        
        // Render New Transaction Table
        renderTransactionTable(fOrders);
        
        const hourData = new Array(24).fill(0);
        fOrders.forEach(t => { const h = new Date(t.timestamp).getHours(); hourData[h] += t.total; });
        renderChart(hourData);

        const counts = {};
        fOrders.forEach(t => (t.items||[]).forEach(i => counts[i.name] = (counts[i.name]||0) + i.qty));
        const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
        document.getElementById('topItemsList').innerHTML = sorted.map(([n,c])=> 
            `<div class="top-item"><span class="top-name">${n}</span><span class="top-count">${c}x</span></div>`
        ).join('') || '<div class="text-center text-slate-400 py-4 text-sm">Belum ada data</div>';

        const pairs = {};
        fOrders.forEach(t => {
            const items = (t.items||[]).map(i=>i.name).sort();
            for(let i=0; i<items.length; i++) for(let j=i+1; j<items.length; j++) pairs[`${items[i]} + ${items[j]}`] = (pairs[`${items[i]} + ${items[j]}`]||0)+1;
        });
        const sortedPairs = Object.entries(pairs).sort((a,b)=>b[1]-a[1]).slice(0,4);
        document.getElementById('basketAnalysis').innerHTML = sortedPairs.map(([k,v])=>
            `<div class="basket-item">${k} <span class="text-indigo-500 ml-1">(${v})</span></div>`
        ).join('') || '<div class="col-span-2 text-center text-slate-400 py-10 text-sm">Belum ada pola transaksi</div>';

        updateShiftMonitoringFromOrders(fOrders);
    }

    // --- NEW: RENDER TRANSACTION TABLE ---
    function renderTransactionTable(orders) {
        const tbody = document.getElementById('transactionTableBody');
        
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">Belum ada data</td></tr>';
            return;
        }

        // Sort desc
        const sorted = [...orders].sort((a, b) => b.timestamp - a.timestamp);

        tbody.innerHTML = sorted.map(t => {
            const date = new Date(t.timestamp);
            const timeStr = date.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
            
            // Logic Shift
            const h = date.getHours();
            let shift = 'Malam', shiftColor = 'bg-purple-100 text-purple-700';
            if (h >= 0 && h < 8) { shift = 'Pagi'; shiftColor = 'bg-yellow-100 text-yellow-800'; }
            else if (h >= 8 && h < 16) { shift = 'Siang'; shiftColor = 'bg-teal-100 text-teal-700'; }

            return `
                <tr class="hover:bg-slate-50 transition">
                    <td class="font-mono text-xs text-slate-500">${timeStr}</td>
                    <td><span class="${shiftColor} px-2 py-1 rounded text-xs font-bold">${shift}</span></td>
                    <td class="font-medium text-slate-700">${t.table || '-'} / ${t.customer || 'Guest'}</td>
                    <td><span class="text-xs font-bold px-2 py-1 rounded ${t.paymentMethod === 'QRIS' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'}">${t.paymentMethod || 'CASH'}</span></td>
                    <td class="text-right font-bold text-slate-700">${fmt(t.total)}</td>
                </tr>
            `;
        }).join('');
    }

    // [UPDATED] SHIFT LOGIC (00-08, 08-16, 16-24)
    function updateShiftMonitoringFromOrders(data) {
        const totals = { Pagi:{q:0,c:0}, Siang:{q:0,c:0}, Malam:{q:0,c:0} };
        data.forEach(o => {
            const h = new Date(o.timestamp).getHours();
            let s = ''; 
            
            // Logika Shift Baru
            if (h >= 0 && h < 8) s = 'Pagi';         // 00:00 - 07:59
            else if (h >= 8 && h < 16) s = 'Siang';  // 08:00 - 15:59
            else s = 'Malam';                        // 16:00 - 23:59
            
            const m = (o.paymentMethod||'').toLowerCase();
            if(m.includes('qris') || m.includes('transfer')) totals[s].q += o.total; else totals[s].c += o.total;
        });
        
        ['Pagi','Siang','Malam'].forEach(k => {
            const kl = k.toLowerCase();
            document.getElementById(`${kl}-qris`).innerText = fmt(totals[k].q);
            document.getElementById(`${kl}-cash`).innerText = fmt(totals[k].c);
            document.getElementById(`${kl}-total`).innerText = fmt(totals[k].q + totals[k].c);
        });
    }

    function renderStaffTable() {
        const tbody = document.getElementById('staffDataTable');
        const fShifts = filterData(allShiftReports.map(d=>({...d, timestamp: d.createdAt?.seconds*1000})), currentFilter);
        
        if(fShifts.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">Belum ada data shift</td></tr>'; return; }

        tbody.innerHTML = fShifts.map(r => `
            <tr>
                <td>${r.date}</td>
                <td><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600">${r.shift}</span></td>
                <td>${r.staffName}</td>
                <td>${fmt(r.startCash)}</td>
                <td>${fmt(r.physicalCash)}</td>
                <td class="${r.difference<0?'text-red-500':'text-green-500'} font-bold">${fmt(r.difference)}</td>
            </tr>
        `).join('');
    }

    function renderChart(data) {
        const ctx = document.getElementById('peakHourChart');
        if(peakHourChart) peakHourChart.destroy();
        peakHourChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: Array.from({length:24},(_,i)=>`${i}:00`), datasets:[{label:'Penjualan', data:data, backgroundColor:'#6366f1', borderRadius:4}] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{color:'#f1f5f9'}}, x:{grid:{display:false}}} }
        });
    }

    window.switchTab = (tab) => {
        document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tab}-section`).classList.add('active');
        document.getElementById(`tab-btn-${tab}`).classList.add('active');
    };

    window.setFilter = (filter) => {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-indigo-100','text-indigo-700'));
        document.getElementById(`btn-${filter}`).classList.add('bg-indigo-100','text-indigo-700');
        updateMonitoring();
        renderStaffTable();
    };

    window.updateFinType = () => {
        const val = document.getElementById('fin-category').value;
        const badge = document.getElementById('fin-type-badge');
        const hidden = document.getElementById('fin-type');
        if(!val) { badge.classList.add('hidden'); return; }
        
        const code = val.split('|')[0];
        const isIncome = code === '7101';
        badge.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
        if(isIncome) {
            badge.classList.add('bg-green-100', 'text-green-700');
            badge.innerText = "üí∞ Pemasukan (In)";
            hidden.value = 'in';
        } else {
            badge.classList.add('bg-red-100', 'text-red-700');
            badge.innerText = "üí∏ Pengeluaran (Out)";
            hidden.value = 'out';
        }
    };

    window.submitFinance = async (e) => {
        e.preventDefault();
        const catRaw = document.getElementById('fin-category').value;
        const amt = parseInt(document.getElementById('fin-amount').value);
        const note = document.getElementById('fin-note').value;
        const type = document.getElementById('fin-type').value;

        if(!catRaw || amt <= 0) return alert("Data tidak lengkap");
        const [code, name] = catRaw.split('|');

        try {
            await addDoc(collection(db, "financial_transactions"), {
                coaCode: code, category: name, amount: amt, type: type, description: note,
                user: auth.currentUser.email, date: new Date().toLocaleDateString('id-ID'), timestamp: Date.now(), createdAt: serverTimestamp()
            });
            alert("Transaksi tersimpan!");
            e.target.reset(); document.getElementById('fin-type-badge').classList.add('hidden');
        } catch(err) { alert("Error: " + err.message); }
    };

    function renderFinanceTable() {
        const tbody = document.getElementById('financeTableBody');
        if(allFinanceLogs.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">Belum ada data</td></tr>'; return; }
        tbody.innerHTML = allFinanceLogs.map(t => `
            <tr>
                <td>${new Date(t.timestamp).toLocaleDateString('id-ID')}</td>
                <td><span class="text-xs font-mono bg-slate-100 px-1 rounded mr-1">${t.coaCode}</span> ${t.category}</td>
                <td class="text-slate-500 italic text-xs">${t.description}</td>
                <td class="text-right font-bold ${t.type==='in'?'text-green-600':'text-red-600'}">${t.type==='in'?'+':'-'} ${fmt(t.amount)}</td>
                <td><span class="tag ${t.type==='in'?'tag-in':'tag-out'}">${t.type.toUpperCase()}</span></td>
            </tr>
        `).join('');
    }

    // FUNCTION: downloadReport (Fixed ReferenceError)
    window.downloadReport = () => {
        let csv = 'Tanggal,Shift,Staff,Modal,QRIS,Cash,Bon,Fisik,Selisih\n';
        const fShifts = filterData(allShiftReports.map(d=>({...d, timestamp: d.createdAt?.seconds*1000})), currentFilter);
        
        fShifts.forEach(r => {
            const note = (r.notes || '').replace(/,/g, ' ');
            csv += `${r.date},${r.shift},${r.staffName},${r.startCash},${r.qrisSales},${r.cashSales},${r.expenses},${r.physicalCash},${r.difference}\n`;
        });
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = `Laporan_Shift_${currentFilter}.csv`; 
        a.click();
        URL.revokeObjectURL(url);
    };

    function fmt(n) { return 'Rp ' + (n||0).toLocaleString('id-ID'); }
    function showError(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 4000); }
  </script>
 </body>
</html>
