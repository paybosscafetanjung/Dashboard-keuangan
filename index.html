<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payboss - Dashboard Keuangan & Closing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 min-h-screen relative pb-20">

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ðŸ”’ Akses Manager</h2>
                <p class="text-gray-500 text-sm">Login untuk akses data keuangan & closing.</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Gagal login.</div>
                <button type="submit" id="btn-login" class="w-full py-2 px-4 bg-blue-900 text-white rounded-md font-bold hover:bg-blue-800">Masuk</button>
            </form>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content" class="filter blur-sm pointer-events-none transition duration-500 max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ðŸ“Š Dashboard Keuangan</h1>
                <p class="text-gray-600">Pantau Arus Kas & Closing Shift</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-white px-4 py-2 rounded-lg shadow text-right">
                    <span class="text-xs text-gray-500 block">Tanggal Laporan:</span>
                    <span id="current-date" class="font-bold text-gray-800 text-sm">...</span>
                </div>
                <button id="btn-logout" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 text-sm font-bold">Keluar</button>
            </div>
        </div>

        <!-- FITUR BARU: KALKULATOR CLOSING (REKONSILIASI) -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden mb-8">
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">ðŸ§® Kalkulator Closing Kasir</h2>
                <button onclick="resetCalculator()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">Reset</button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
                
                <!-- KOLOM 1: INPUT FISIK -->
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-700 border-b pb-2">1. Input Fisik (Dari Kasir)</h3>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">Modal Awal (Cash In)</label>
                        <input type="number" id="input-modal-awal" oninput="calculateClosing()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 outline-none text-right font-mono" placeholder="0">
                        <p class="text-xs text-gray-400 mt-1">*Lihat data di Absensi Masuk</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">Total Uang di Laci (Cash Out)</label>
                        <input type="number" id="input-fisik-akhir" oninput="calculateClosing()" class="w-full p-3 border-2 border-blue-500 rounded-lg focus:ring-2 focus:ring-blue-200 outline-none text-right font-mono font-bold text-lg" placeholder="0">
                        <p class="text-xs text-gray-400 mt-1">*Hitung semua uang tunai di laci</p>
                    </div>
                    
                    <!-- PENGELUARAN KAS KECIL (OPSIONAL) -->
                     <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">Pengeluaran Kas Kecil (Jika ada)</label>
                        <input type="number" id="input-pengeluaran" oninput="calculateClosing()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 outline-none text-right font-mono text-orange-600" placeholder="0">
                        <p class="text-xs text-gray-400 mt-1">*Misal: Beli es batu, gas, dll</p>
                    </div>
                </div>

                <!-- KOLOM 2: DATA SISTEM (OTOMATIS) -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">2. Data Sistem (Otomatis)</h3>
                    
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-600">Penjualan Cash Sistem:</span>
                        <span id="system-cash-display" class="font-bold text-gray-800 text-lg">Rp 0</span>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-600">Penjualan QRIS Sistem:</span>
                        <span id="system-qris-display" class="font-bold text-green-600">Rp 0</span>
                    </div>

                    <div class="border-t pt-4">
                        <p class="text-sm text-gray-500 mb-1">Rumus Pendapatan Bersih Fisik:</p>
                        <p class="font-mono text-sm bg-white p-2 rounded border text-center">
                            (Total Laci - Modal Awal) + Pengeluaran
                        </p>
                        <div class="flex justify-between items-center mt-4">
                            <span class="font-bold text-gray-700">Pendapatan Fisik:</span>
                            <span id="calculated-physical-revenue" class="font-bold text-blue-600 text-xl">Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- KOLOM 3: HASIL (SELISIH) -->
                <div class="text-center flex flex-col justify-center h-full">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-6">3. Hasil Rekonsiliasi</h3>
                    
                    <div id="result-box" class="p-6 rounded-2xl border-4 border-gray-200 bg-gray-50 transition-all duration-300">
                        <p class="text-gray-500 font-bold uppercase text-sm mb-2">Status Selisih</p>
                        <div id="variance-amount" class="text-4xl font-black text-gray-800 mb-2">Rp 0</div>
                        <div id="variance-status" class="inline-block px-4 py-1 rounded-full text-sm font-bold bg-gray-200 text-gray-600">Belum Input</div>
                    </div>
                    
                    <p class="text-xs text-gray-400 mt-4 px-4 text-left">
                        * Hijau: Klop (Aman).<br>
                        * Merah: Minus (Uang hilang/kurang).<br>
                        * Biru: Plus (Kelebihan uang).
                    </p>
                </div>
            </div>
        </div>

        <!-- Live Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow card border-l-4 border-blue-500">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Total Omset Hari Ini</h3>
                <p id="total-revenue" class="text-3xl font-bold text-gray-800 mt-2">Rp 0</p>
                <p class="text-xs text-gray-400 mt-2">Cash + QRIS</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow card border-l-4 border-green-500">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Total Masuk via QRIS</h3>
                <p id="qris-revenue" class="text-3xl font-bold text-green-600 mt-2">Rp 0</p>
                <p id="qris-count" class="text-xs text-gray-400 mt-2">0 Transaksi</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow card border-l-4 border-yellow-500">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Total Masuk via Cash</h3>
                <p id="cash-revenue" class="text-3xl font-bold text-yellow-600 mt-2">Rp 0</p>
                <p id="cash-count" class="text-xs text-gray-400 mt-2">0 Transaksi</p>
            </div>
        </div>

        <!-- Tabel Riwayat -->
        <div class="bg-white p-6 rounded-xl shadow overflow-hidden">
            <h3 class="font-bold text-gray-700 mb-4">Riwayat Transaksi Live</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-100 text-gray-600 border-b">
                        <tr>
                            <th class="py-3 px-4">Jam</th>
                            <th class="py-3 px-4">Pelanggan</th>
                            <th class="py-3 px-4">Metode</th>
                            <th class="py-3 px-4 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="divide-y divide-gray-200">
                        <tr><td colspan="4" class="py-4 text-center text-gray-400">Menunggu data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
            authDomain: "payboss-cafe-system.firebaseapp.com",
            projectId: "payboss-cafe-system",
            storageBucket: "payboss-cafe-system.appspot.com",
            messagingSenderId: "570523503793",
            appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
            measurementId: "G-H1NJ369HE9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global Vars untuk Kalkulasi
        let systemCashTotal = 0;
        let unsubscribeOrders = null;

        // AUTH & LOGIN
        const loginModal = document.getElementById('login-modal');
        const mainContent = document.getElementById('main-content');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginModal.classList.add('hidden');
                mainContent.classList.remove('filter', 'blur-sm', 'pointer-events-none');
                listenToDailyOrders();
            } else {
                loginModal.classList.remove('hidden');
                mainContent.classList.add('filter', 'blur-sm', 'pointer-events-none');
                if (unsubscribeOrders) unsubscribeOrders();
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            const errorMsg = document.getElementById('login-error');
            
            btn.textContent = "Memproses..."; btn.disabled = true; errorMsg.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorMsg.textContent = "Gagal login: " + error.message; errorMsg.classList.remove('hidden');
                btn.textContent = "Masuk"; btn.disabled = false;
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        // CORE LOGIC: FETCH DATA & UPDATE UI
        function listenToDailyOrders() {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));

            unsubscribeOrders = onSnapshot(q, (snapshot) => {
                let totalRev = 0, qrisRev = 0, cashRev = 0, qrisCount = 0, cashCount = 0;
                const tableBody = document.getElementById('transaction-list');
                tableBody.innerHTML = ''; 
                let hasData = false;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!data.createdAt) return;
                    const orderDate = data.createdAt.toDate();
                    
                    // Filter Hari Ini
                    if (orderDate.setHours(0,0,0,0) === today.getTime()) {
                        hasData = true;
                        const amount = data.total || 0;
                        totalRev += amount;

                        const method = (data.paymentMethod || 'unknown').toLowerCase();
                        
                        // Perbaikan logika deteksi metode pembayaran
                        if (method.includes('qris')) { 
                            qrisRev += amount; 
                            qrisCount++; 
                        } else { 
                            // Asumsi default selain QRIS adalah Cash
                            cashRev += amount; 
                            cashCount++; 
                        }

                        // Render Tabel (Max 10)
                        if (tableBody.children.length < 10) {
                            const timeString = data.createdAt.toDate().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                            const badgeColor = method.includes('qris') ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                            
                            tableBody.innerHTML += `
                                <tr class="hover:bg-gray-50 border-b border-gray-100">
                                    <td class="py-3 px-4 text-gray-500 text-xs">${timeString}</td>
                                    <td class="py-3 px-4 font-semibold text-gray-700">${data.customer || '-'}</td>
                                    <td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeColor}">${data.paymentMethod}</span></td>
                                    <td class="py-3 px-4 text-right font-bold text-gray-700">Rp ${amount.toLocaleString('id-ID')}</td>
                                </tr>`;
                        }
                    }
                });

                if (!hasData) tableBody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-400 italic">Belum ada transaksi hari ini</td></tr>';

                // Update Cards
                document.getElementById('total-revenue').textContent = `Rp ${totalRev.toLocaleString('id-ID')}`;
                document.getElementById('qris-revenue').textContent = `Rp ${qrisRev.toLocaleString('id-ID')}`;
                document.getElementById('cash-revenue').textContent = `Rp ${cashRev.toLocaleString('id-ID')}`;
                document.getElementById('qris-count').textContent = `${qrisCount} Trx`;
                document.getElementById('cash-count').textContent = `${cashCount} Trx`;

                // Update Kalkulator Data Sistem
                systemCashTotal = cashRev;
                document.getElementById('system-cash-display').textContent = `Rp ${cashRev.toLocaleString('id-ID')}`;
                document.getElementById('system-qris-display').textContent = `Rp ${qrisRev.toLocaleString('id-ID')}`;
                
                // Recalculate jika user sudah input angka sebelumnya
                calculateClosing();

            }, (error) => {
                console.error("Error:", error);
                if (error.code === 'permission-denied') alert("Izin Ditolak! Pastikan login.");
            });
        }

        // FUNGSI KALKULATOR CLOSING
        window.calculateClosing = function() {
            // Ambil Input User
            const modalAwal = parseFloat(document.getElementById('input-modal-awal').value) || 0;
            const fisikAkhir = parseFloat(document.getElementById('input-fisik-akhir').value) || 0;
            const pengeluaran = parseFloat(document.getElementById('input-pengeluaran').value) || 0;

            // Hitung Pendapatan Fisik (Realita)
            // Rumus: Uang di Laci - Modal Awal + Pengeluaran yang terpakai dari laci
            const pendapatanFisik = (fisikAkhir - modalAwal) + pengeluaran;

            // Hitung Selisih
            const selisih = pendapatanFisik - systemCashTotal;

            // Update UI
            document.getElementById('calculated-physical-revenue').textContent = `Rp ${pendapatanFisik.toLocaleString('id-ID')}`;
            
            const varianceBox = document.getElementById('result-box');
            const varianceAmt = document.getElementById('variance-amount');
            const varianceSts = document.getElementById('variance-status');

            varianceAmt.textContent = `Rp ${selisih.toLocaleString('id-ID')}`;

            if (document.getElementById('input-fisik-akhir').value === '') {
                // Belum input lengkap
                varianceBox.className = "p-6 rounded-2xl border-4 border-gray-200 bg-gray-50";
                varianceAmt.className = "text-4xl font-black text-gray-400 mb-2";
                varianceSts.textContent = "Menunggu Input...";
                varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-gray-200 text-gray-500";
            } else if (selisih === 0) {
                // Perfect
                varianceBox.className = "p-6 rounded-2xl border-4 border-green-500 bg-green-50";
                varianceAmt.className = "text-4xl font-black text-green-600 mb-2";
                varianceSts.textContent = "âœ… KLOP / SEIMBANG";
                varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-green-200 text-green-800";
            } else if (selisih < 0) {
                // Kurang (Minus)
                varianceBox.className = "p-6 rounded-2xl border-4 border-red-500 bg-red-50";
                varianceAmt.className = "text-4xl font-black text-red-600 mb-2";
                varianceSts.textContent = "âš ï¸ MINUS / KURANG";
                varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-red-200 text-red-800";
            } else {
                // Lebih (Surplus)
                varianceBox.className = "p-6 rounded-2xl border-4 border-blue-500 bg-blue-50";
                varianceAmt.className = "text-4xl font-black text-blue-600 mb-2";
                varianceSts.textContent = "â„¹ï¸ SURPLUS / LEBIH";
                varianceSts.className = "inline-block px-4 py-1 rounded-full text-sm font-bold bg-blue-200 text-blue-800";
            }
        }

        window.resetCalculator = function() {
            document.getElementById('input-modal-awal').value = '';
            document.getElementById('input-fisik-akhir').value = '';
            document.getElementById('input-pengeluaran').value = '';
            calculateClosing();
        }
    </script>
</body>
</html>
