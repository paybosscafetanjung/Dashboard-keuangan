<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayBoss - Kas & Insight</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box; margin: 0; padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }

        /* App Styles */
        html { height: 100%; }
        .nav-bar {
            background: rgba(62, 39, 35, 0.95); padding: 10px 20px; display: flex;
            justify-content: center; align-items: center; position: sticky;
            top: 0; z-index: 1000; backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .nav-brand { color: #D2B48C; font-size: 1.2rem; font-weight: bold; text-decoration: none; }
        .nav-menu { display: flex; gap: 10px; margin-left: 20px; }
        .nav-btn {
            background: transparent; border: 1px solid #D2B48C; color: #D2B48C;
            padding: 5px 15px; border-radius: 20px; cursor: pointer; transition: 0.3s;
        }
        .nav-btn.active, .nav-btn:hover { background: #D2B48C; color: #3E2723; }

        .container { max-width: 1000px; margin: 0 auto; padding: 15px; }
        .page {
            background: rgba(255, 255, 255, 0.98); border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; margin-bottom: 20px;
            animation: fadeIn 0.5s ease; padding: 20px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .page-header h1 { margin: 0; color: #3E2723; font-size: 1.8rem; }
        .page-header p { margin: 5px 0 0; color: #666; font-size: 0.9rem; }

        /* CASH FLOW STYLES */
        .shift-selector {
            background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #ddd;
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center;
            margin-bottom: 20px;
        }
        .shift-selector input, .shift-selector select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        
        .money-card-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;
        }
        .money-card {
            background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .money-card.highlight { background: #e8f5e9; border-color: #c8e6c9; }
        .money-card.highlight .val { color: #2e7d32; }
        .money-card.expense { background: #ffebee; border-color: #ffcdd2; }
        .money-card.expense .val { color: #c62828; }

        .money-card label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        .money-card .val { font-size: 1.4rem; font-weight: bold; color: #3E2723; }
        .money-card small { font-size: 0.8rem; color: #888; }

        .cash-action-area {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        @media(max-width: 700px) { .cash-action-area { grid-template-columns: 1fr; } }

        .action-box { border: 1px solid #ddd; border-radius: 10px; padding: 15px; }
        .action-box h4 { margin-top: 0; color: #3E2723; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-row input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: #8B4513; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .expense-list { margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .expense-item { 
            display: flex; justify-content: space-between; padding: 8px; 
            border-bottom: 1px dashed #eee; font-size: 0.9rem; 
        }
        .expense-time { color: #888; font-size: 0.8rem; margin-right: 5px; }

        /* ANALYTICS STYLES (Existing) */
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 10px; }
        .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media(max-width: 700px) { .insight-grid { grid-template-columns: 1fr; } }
        
        .combo-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        
        /* Loading */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 3000; display: flex; 
            justify-content: center; align-items: center; flex-direction: column; 
        }
        .loader { 
            border: 5px solid #f3f3f3; border-top: 5px solid #8B4513; 
            border-radius: 50%; width: 40px; height: 40px; 
            animation: spin 1s linear infinite; margin-bottom: 15px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <h3 style="color: #3E2723;">Memuat Sistem...</h3>
    </div>

    <nav class="nav-bar">
        <a href="#" class="nav-brand">‚òï PayBoss</a>
        <div class="nav-menu">
            <button class="nav-btn active" onclick="switchPage('cash')">üíµ Kas & Shift</button>
            <button class="nav-btn" onclick="switchPage('analytics')">üìä Analisis Data</button>
        </div>
    </nav>

    <div class="container">
        
        <!-- HALAMAN MANAJEMEN KAS (NEW) -->
        <div id="cash-page" class="page">
            <div class="page-header">
                <h1>Laporan Keuangan Per Shift</h1>
                <p>Kontrol Uang Fisik, Modal & Pengeluaran Kasir</p>
            </div>

            <!-- Kontrol Shift -->
            <div class="shift-selector">
                <div>
                    <label style="font-size:0.8rem; font-weight:bold;">Tanggal:</label>
                    <input type="date" id="cash-date">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:bold;">Pilih Shift:</label>
                    <select id="cash-shift">
                        <option value="1">Shift 1 (08:00 - 15:59)</option>
                        <option value="2">Shift Siang (16:00 - 22:59)</option>
                        <option value="3">Shift Malam (23:00 - 07:59)</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="btn-load-shift">üîç Buka Laporan</button>
            </div>

            <div id="shift-content" class="hidden">
                
                <!-- Input Modal Awal (Jika belum diisi) -->
                <div id="modal-input-section" class="action-box" style="text-align:center; background:#fff8e1; border:1px solid #ffecb3; margin-bottom:20px;">
                    <h3 style="margin-top:0;">‚ö†Ô∏è Modal Awal Belum Dimasukkan</h3>
                    <p>Masukkan jumlah uang tunai yang ada di laci sebelum memulai shift ini.</p>
                    <div style="display:flex; justify-content:center; gap:10px; max-width:300px; margin:0 auto;">
                        <input type="number" id="input-modal" placeholder="Rp 0" style="padding:10px; width:100%;">
                        <button class="btn btn-success" id="btn-save-modal">Simpan</button>
                    </div>
                </div>

                <!-- Dashboard Angka -->
                <div id="shift-dashboard" class="hidden">
                    <div class="money-card-grid">
                        <div class="money-card">
                            <label>Modal Awal</label>
                            <div class="val" id="disp-modal">Rp 0</div>
                            <small>Start Laci</small>
                        </div>
                        <div class="money-card">
                            <label>Pendapatan Cash</label>
                            <div class="val" id="disp-cash-in" style="color:#2e7d32;">+ Rp 0</div>
                            <small>Dari Penjualan Tunai</small>
                        </div>
                        <div class="money-card expense">
                            <label>Pengeluaran (Bon)</label>
                            <div class="val" id="disp-expenses">- Rp 0</div>
                            <small>Ambil dari Laci</small>
                        </div>
                        <div class="money-card highlight">
                            <label>Uang Fisik di Laci</label>
                            <div class="val" id="disp-drawer-total">Rp 0</div>
                            <small>(Modal + Cash) - Bon</small>
                        </div>
                         <div class="money-card" style="background:#f3e5f5; border-color:#e1bee7;">
                            <label>Total QRIS/Transfer</label>
                            <div class="val" id="disp-qris-in" style="color:#6a1b9a;">Rp 0</div>
                            <small>Masuk ke Rekening</small>
                        </div>
                    </div>

                    <!-- Area Input Pengeluaran & Ringkasan -->
                    <div class="cash-action-area">
                        <!-- Input Pengeluaran -->
                        <div class="action-box">
                            <h4>üìù Catat Pengeluaran (Bon)</h4>
                            <div class="form-row">
                                <input type="text" id="exp-desc" placeholder="Keperluan (Es, Gas, dll)">
                            </div>
                            <div class="form-row">
                                <input type="number" id="exp-amount" placeholder="Nominal (Rp)">
                                <button class="btn btn-danger" id="btn-add-expense">Catat</button>
                            </div>
                            <div class="expense-list" id="expense-history-list">
                                <!-- List Item -->
                            </div>
                        </div>

                        <!-- Ringkasan Shift -->
                        <div class="action-box" style="background:#f9f9f9;">
                            <h4>üìã Ringkasan Shift</h4>
                            <p id="shift-summary-text" style="line-height:1.6; font-size:0.95rem; color:#444;">
                                Memuat data...
                            </p>
                            <button class="btn btn-primary" style="width:100%; margin-top:10px;" id="btn-print-shift">üñ®Ô∏è Cetak Laporan Shift</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HALAMAN ANALISIS DATA (EXISTING) -->
        <div id="analytics-page" class="page hidden">
            <div class="page-header">
                <h1>üìä Analisis Penjualan</h1>
                <p>Tren Penjualan & Perilaku Pelanggan</p>
            </div>
            
            <div class="shift-selector">
                <label>Filter:</label>
                <input type="date" id="start-date">
                <span>s/d</span>
                <input type="date" id="end-date">
                <button id="load-analytics-btn" class="btn btn-primary">Analisis</button>
            </div>

            <div class="money-card-grid">
                <div class="money-card">
                    <label>Total Omzet Periodik</label>
                    <div class="val" id="anl-total-sales">Rp 0</div>
                </div>
                <div class="money-card">
                    <label>Total Transaksi</label>
                    <div class="val" id="anl-total-orders">0</div>
                </div>
            </div>

            <div class="insight-grid">
                <div>
                    <h3 style="text-align:center;">‚è∞ Tren Jam Sibuk</h3>
                    <div class="chart-container"><canvas id="peakHourChart"></canvas></div>
                </div>
                <div>
                    <h3 style="text-align:center;">üìÖ Tren Hari Sibuk</h3>
                    <div class="chart-container"><canvas id="peakDayChart"></canvas></div>
                </div>
            </div>
            
            <div style="margin-top:20px;">
                <h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">üèÜ Top Menu & Kombinasi</h3>
                <div id="combo-insight-list"></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, getDocs, Timestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- ENVIRONMENT CONFIG (Mandatory for Preview) ---
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.warn("Using fallback config");
            firebaseConfig = {
                apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc", // Fallback for UI visualization only
                authDomain: "payboss-cafe-system.firebaseapp.com",
                projectId: "payboss-cafe-system"
            };
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Use Global App ID for artifacts path
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- HELPER: Strict Path Builder ---
        // Semua data harus masuk ke sini agar tidak error permission
        const getColRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);

        // --- GLOBAL VARIABLES ---
        let currentShiftData = null; // Menyimpan data modal & pengeluaran
        let currentShiftSales = { cash: 0, qris: 0, orders: 0 }; // Menyimpan data penjualan
        let charts = {};

        // --- INIT ---
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('cash-date').value = todayStr;
        document.getElementById('start-date').value = todayStr;
        document.getElementById('end-date').value = todayStr;

        // AUTH INITIALIZATION (Robust)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.warn("Auth failed, retrying anon:", err);
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loading-overlay').classList.add('hidden');
                console.log("Logged in as", user.uid);
            }
        });

        // --- NAVIGASI ---
        window.switchPage = (pageName) => {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            if(pageName === 'cash') {
                document.getElementById('cash-page').classList.remove('hidden');
                document.querySelector('button[onclick="switchPage(\'cash\')"]').classList.add('active');
            } else {
                document.getElementById('analytics-page').classList.remove('hidden');
                document.querySelector('button[onclick="switchPage(\'analytics\')"]').classList.add('active');
            }
        };

        // ==========================================
        // 1. LOGIKA SHIFT & KAS (CORE FEATURE)
        // ==========================================

        document.getElementById('btn-load-shift').addEventListener('click', loadShiftReport);

        async function loadShiftReport() {
            if (!auth.currentUser) return alert("Menunggu login...");

            const dateStr = document.getElementById('cash-date').value;
            const shiftId = document.getElementById('cash-shift').value;
            const contentDiv = document.getElementById('shift-content');
            
            contentDiv.classList.remove('hidden');
            contentDiv.style.opacity = '0.5'; // Loading effect

            // 1. Tentukan Rentang Waktu Shift
            let start, end;
            const baseDate = new Date(dateStr);
            
            if (shiftId === '1') {
                start = new Date(baseDate); start.setHours(8,0,0,0);
                end = new Date(baseDate); end.setHours(15,59,59,999);
            } else if (shiftId === '2') {
                start = new Date(baseDate); start.setHours(16,0,0,0);
                end = new Date(baseDate); end.setHours(22,59,59,999);
            } else {
                start = new Date(baseDate); start.setHours(23,0,0,0);
                end = new Date(baseDate); end.setDate(end.getDate() + 1); end.setHours(7,59,59,999);
            }

            // 2. Ambil Data Penjualan (Completed Orders)
            // UPDATED: Use Artifact Path to ensure it works in preview
            const qSales = query(
                getColRef("completedOrders"),
                where("completedAt", ">=", Timestamp.fromDate(start)),
                where("completedAt", "<=", Timestamp.fromDate(end))
            );
            
            try {
                const salesSnap = await getDocs(qSales);
                currentShiftSales = { cash: 0, qris: 0, orders: salesSnap.size };

                salesSnap.forEach(doc => {
                    const data = doc.data();
                    const total = data.total || 0;
                    const method = (data.paymentMethod || '').toLowerCase();
                    
                    if (method.includes('cash') || method.includes('tunai')) {
                        currentShiftSales.cash += total;
                    } else {
                        currentShiftSales.qris += total;
                    }
                });
            } catch (e) {
                console.error("Error fetching orders:", e);
                // Fail gracefully
                currentShiftSales = { cash: 0, qris: 0, orders: 0 };
            }

            // 3. Ambil Data Kas (Modal & Pengeluaran)
            const reportId = `${dateStr}_SHIFT_${shiftId}`;
            const reportRef = getDocRef("shiftReports", reportId);
            
            try {
                const reportSnap = await getDoc(reportRef);

                if (reportSnap.exists()) {
                    currentShiftData = reportSnap.data();
                    showShiftDashboard(); 
                } else {
                    currentShiftData = { id: reportId, date: dateStr, shift: shiftId, startCapital: 0, expenses: [] };
                    showModalInput(); 
                }
            } catch (e) {
                console.error("Error loading shift report:", e);
                alert("Gagal memuat laporan. Coba refresh halaman.");
            }

            contentDiv.style.opacity = '1';
        }

        function showModalInput() {
            document.getElementById('modal-input-section').classList.remove('hidden');
            document.getElementById('shift-dashboard').classList.add('hidden');
        }

        function showShiftDashboard() {
            document.getElementById('modal-input-section').classList.add('hidden');
            document.getElementById('shift-dashboard').classList.remove('hidden');
            renderShiftCalculations();
            renderExpenseList();
        }

        // --- SIMPAN MODAL AWAL ---
        document.getElementById('btn-save-modal').addEventListener('click', async () => {
            const amountInput = document.getElementById('input-modal').value;
            const amount = parseInt(amountInput);
            
            if (isNaN(amount) || amount < 0) return alert("Masukkan nominal valid (minimal 0)");

            const btn = document.getElementById('btn-save-modal');
            btn.textContent = "Menyimpan...";
            btn.disabled = true;

            try {
                currentShiftData.startCapital = amount;
                const reportRef = getDocRef("shiftReports", currentShiftData.id);
                await setDoc(reportRef, currentShiftData);
                showShiftDashboard();
            } catch (e) {
                console.error(e);
                alert("Gagal simpan modal.");
            } finally {
                btn.textContent = "Simpan";
                btn.disabled = false;
            }
        });

        // --- HITUNG LOGIKA UANG LACI ---
        function renderShiftCalculations() {
            const modal = currentShiftData.startCapital || 0;
            const cashIn = currentShiftSales.cash || 0;
            const totalExpenses = (currentShiftData.expenses || []).reduce((sum, item) => sum + item.amount, 0);
            
            const drawerTotal = modal + cashIn - totalExpenses;

            document.getElementById('disp-modal').textContent = fmtRp(modal);
            document.getElementById('disp-cash-in').textContent = "+ " + fmtRp(cashIn);
            document.getElementById('disp-expenses').textContent = "- " + fmtRp(totalExpenses);
            document.getElementById('disp-drawer-total').textContent = fmtRp(drawerTotal);
            document.getElementById('disp-qris-in').textContent = fmtRp(currentShiftSales.qris);

            const shiftName = document.getElementById('cash-shift').selectedOptions[0].text;
            document.getElementById('shift-summary-text').innerHTML = `
                <strong>${shiftName} (${currentShiftData.date})</strong><br>
                Total Transaksi: ${currentShiftSales.orders} Pesanan<br>
                Pendapatan Bersih (Cash+QRIS): ${fmtRp(cashIn + currentShiftSales.qris)}<br>
                Pengeluaran Operasional: ${fmtRp(totalExpenses)}<br>
                -----------------------------------<br>
                <strong>Uang Fisik Wajib Setor: ${fmtRp(drawerTotal)}</strong>
            `;
        }

        // --- TAMBAH PENGELUARAN (BON) ---
        document.getElementById('btn-add-expense').addEventListener('click', async () => {
            const desc = document.getElementById('exp-desc').value;
            const amount = parseInt(document.getElementById('exp-amount').value);
            
            if (!desc || isNaN(amount) || amount <= 0) return alert("Isi keterangan dan nominal valid!");

            const newExpense = {
                desc: desc,
                amount: amount,
                time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})
            };

            const btn = document.getElementById('btn-add-expense');
            btn.disabled = true; 
            btn.textContent = "...";

            try {
                const reportRef = getDocRef("shiftReports", currentShiftData.id);
                
                // Optimistic Update
                if(!currentShiftData.expenses) currentShiftData.expenses = [];
                currentShiftData.expenses.push(newExpense);
                
                await updateDoc(reportRef, {
                    expenses: currentShiftData.expenses 
                });
                
                renderShiftCalculations();
                renderExpenseList();
                
                document.getElementById('exp-desc').value = '';
                document.getElementById('exp-amount').value = '';
            } catch (e) {
                console.error(e);
                alert("Gagal catat pengeluaran.");
            } finally {
                btn.disabled = false;
                btn.textContent = "Catat";
            }
        });

        function renderExpenseList() {
            const list = document.getElementById('expense-history-list');
            list.innerHTML = '';
            (currentShiftData.expenses || []).forEach(exp => {
                const div = document.createElement('div');
                div.className = 'expense-item';
                div.innerHTML = `
                    <span><span class="expense-time">${exp.time}</span> ${exp.desc}</span>
                    <span style="color:#c62828;">-${fmtRp(exp.amount)}</span>
                `;
                list.appendChild(div);
            });
        }

        document.getElementById('btn-print-shift').addEventListener('click', () => {
            const modal = currentShiftData.startCapital;
            const cash = currentShiftSales.cash;
            const exp = (currentShiftData.expenses || []).reduce((s, i) => s + i.amount, 0);
            const drawer = modal + cash - exp;
            
            let text = "--- LAPORAN SHIFT ---\n";
            text += `Tgl: ${currentShiftData.date}\n`;
            text += `Shift: ${document.getElementById('cash-shift').selectedOptions[0].text}\n`;
            text += "--------------------------------\n";
            text += `Modal Awal     : ${fmtRp(modal)}\n`;
            text += `Penjualan Cash : ${fmtRp(cash)}\n`;
            text += `Penjualan QRIS : ${fmtRp(currentShiftSales.qris)}\n`;
            text += `Pengeluaran    : (${fmtRp(exp)})\n`;
            text += "--------------------------------\n";
            text += `TOTAL UANG LACI: ${fmtRp(drawer)}\n`;
            text += "--------------------------------\n";
            text += "Rincian Pengeluaran:\n";
            (currentShiftData.expenses || []).forEach(e => {
                text += `- ${e.desc} (${fmtRp(e.amount)})\n`;
            });
            text += "\n\n";

            window.open(`rawbt:${encodeURIComponent(text)}`, '_blank');
        });


        // ==========================================
        // 2. LOGIKA ANALISIS (UPDATED TO ARTIFACT PATH)
        // ==========================================
        document.getElementById('load-analytics-btn').addEventListener('click', loadAnalytics);

        async function loadAnalytics() {
            const startStr = document.getElementById('start-date').value;
            const endStr = document.getElementById('end-date').value;
            
            const start = new Date(startStr); start.setHours(0,0,0,0);
            const end = new Date(endStr); end.setHours(23,59,59,999);

            const q = query(getColRef("completedOrders"), 
                where("completedAt", ">=", Timestamp.fromDate(start)),
                where("completedAt", "<=", Timestamp.fromDate(end))
            );

            try {
                const snap = await getDocs(q);
                const orders = snap.docs.map(d => d.data());

                const total = orders.reduce((s, o) => s + o.total, 0);
                document.getElementById('anl-total-sales').textContent = fmtRp(total);
                document.getElementById('anl-total-orders').textContent = orders.length;

                const hours = Array(24).fill(0);
                const days = Array(7).fill(0);
                const combos = {};

                orders.forEach(o => {
                    const date = new Date(o.completedAt.seconds * 1000);
                    hours[date.getHours()]++;
                    days[date.getDay()]++;
                    
                    const items = [...new Set((o.items||[]).map(i => i.name))];
                    if(items.length > 1) {
                        for(let i=0; i<items.length; i++) {
                            for(let j=i+1; j<items.length; j++) {
                                const k = [items[i], items[j]].sort().join(' + ');
                                combos[k] = (combos[k] || 0) + 1;
                            }
                        }
                    }
                });

                renderCharts(hours, days);
                
                const sortedCombo = Object.entries(combos).sort(([,a],[,b]) => b-a).slice(0,5);
                document.getElementById('combo-insight-list').innerHTML = sortedCombo.length 
                    ? sortedCombo.map(([n,c]) => `<div class="combo-item"><span>${n}</span><strong>${c}x</strong></div>`).join('')
                    : '<p style="text-align:center; color:#888;">Belum ada pola kombinasi.</p>';
            } catch (e) {
                console.error("Analytics error:", e);
                alert("Gagal memuat analisis.");
            }
        }

        function renderCharts(hData, dData) {
            if(charts.hour) charts.hour.destroy();
            if(charts.day) charts.day.destroy();

            charts.hour = new Chart(document.getElementById('peakHourChart'), {
                type: 'bar',
                data: { labels: Array.from({length:24},(_,i)=>`${i}:00`), datasets: [{label:'Order', data:hData, backgroundColor:'#8B4513'}] },
                options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
            });

            charts.day = new Chart(document.getElementById('peakDayChart'), {
                type: 'bar',
                data: { labels: ['Min','Sen','Sel','Rab','Kam','Jum','Sab'], datasets: [{label:'Order', data:dData, backgroundColor:'#D2B48C'}] },
                options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
            });
        }

        function fmtRp(n) { return "Rp " + (n||0).toLocaleString('id-ID'); }

    </script>
</body>
</html>
